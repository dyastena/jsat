--
-- FILE: database_schema.sql
-- PROJECT: JSAT - Java Skill Assessment Tool
-- BACKEND: Supabase (PostgreSQL)
-- PURPOSE: Single source of truth for schema, RLS, and Auth integration.
--

-- ====================================================================
-- 1. ENUMS AND TYPES
-- ====================================================================

-- Define fixed values for question difficulty
CREATE TYPE difficulty_level AS ENUM ('Easy', 'Medium', 'Hard', 'Expert');

-- ====================================================================
-- 2. CORE TABLES & RLS SETUP
-- ====================================================================

-- PROFILES: Links Supabase Auth to application roles.
CREATE TABLE profiles (
    -- PK is a FK to the built-in auth.users table
    id UUID REFERENCES auth.users NOT NULL PRIMARY KEY, 
    
    -- Role is essential for RLS and app logic
    role TEXT NOT NULL CHECK (role IN ('Candidate', 'Recruiter', 'Admin')), 
    
    first_name TEXT,
    last_name TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Ensure RLS is enabled on all security-critical tables
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE results ENABLE ROW LEVEL SECURITY; -- Assuming 'results' table definition follows

-- ====================================================================
-- 3. ASSESSMENT TABLES
-- ====================================================================

-- EXAMS TABLE
CREATE TABLE exams (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    created_by UUID REFERENCES profiles(id), 
    duration_minutes INTEGER NOT NULL,
    required_skill_level difficulty_level NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- QUESTIONS TABLE
CREATE TABLE questions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    exam_id BIGINT REFERENCES exams(id) NOT NULL,
    question_text TEXT NOT NULL,
    expected_output TEXT,
    test_case_data JSONB, -- Flexible storage for multiple test cases
    difficulty difficulty_level NOT NULL
);

-- RESULTS TABLE (Must be after profiles and exams)
CREATE TABLE results (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    candidate_id UUID REFERENCES profiles(id) NOT NULL, -- Link to the Candidate profile
    exam_id BIGINT REFERENCES exams(id) NOT NULL,
    score NUMERIC(5, 2) NOT NULL,
    detailed_feedback JSONB, -- Output of the CART Engine
    submitted_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE (candidate_id, exam_id)
);


-- ====================================================================
-- 4. RLS POLICIES
-- ====================================================================

-- --- PROFILES POLICIES ---
-- 1. Allow authenticated user to create their own profile upon signup
CREATE POLICY "Allow public insert on own profile" ON profiles 
    FOR INSERT WITH CHECK (auth.uid() = id);

-- 2. Allow Admin/Recruiter to view all profiles
CREATE POLICY "Admin/Recruiter can view all profiles" ON profiles 
    FOR SELECT USING (EXISTS(SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('Admin', 'Recruiter')));

-- 3. Allow user to update only their own profile data (e.g., first/last name)
CREATE POLICY "Users can update own profile" ON profiles 
    FOR UPDATE USING (auth.uid() = id) WITH CHECK (auth.uid() = id);

-- --- RESULTS POLICIES ---
-- 1. Allow Admin/Recruiter to view all results
CREATE POLICY "Admin/Recruiter can view all results" ON results
    FOR SELECT USING (EXISTS(SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('Admin', 'Recruiter')));

-- 2. Allow Candidates to view only their own results
CREATE POLICY "Candidates can view own results" ON results
    FOR SELECT USING (auth.uid() = candidate_id);

-- --- EXAMS POLICIES ---
-- 1. Allow everyone to view exams (Recruiters/Candidates need this)
CREATE POLICY "Allow all authenticated users to view exams" ON exams
    FOR SELECT USING (auth.role() = 'authenticated');
    
-- 2. Allow Admin/Recruiter to manage (INSERT/UPDATE/DELETE) exams
CREATE POLICY "Admin/Recruiter can manage exams" ON exams
    FOR ALL USING (EXISTS(SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('Admin', 'Recruiter')));

-- ====================================================================
-- 5. AUTH TRIGGER
-- ====================================================================

-- Function to automatically create a profile row when a new user signs up
CREATE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, role)
  VALUES (NEW.id, 'Candidate'); -- Default role for new signups is 'Candidate'
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger: Call handle_new_user() after a new user is created in auth.users
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- Disable RLS temporarily to allow the trigger to run (best practice)
ALTER FUNCTION public.handle_new_user() SET search_path = public, ext_http;