<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidates - JSAT Recruiter Panel</title>
    <link href="/dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30">
                        <i data-lucide="satellite" class="w-7 h-7 text-white"></i>
                    </div>
                    <span class="text-2xl font-bold text-white">J-SAT</span>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-1">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="candidates.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-emerald-500/10 text-emerald-500 transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Candidates</span>
                </a>

                <a href="reports-analytics.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Analytics</span>
                </a>
                <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors w-full">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Candidates</h2>
                        <p class="text-gray-400 mt-1">Manage and track all your candidates</p>
                    </div>

                </div>
            </header>

            <!-- Filters and Search -->
            <div class="p-8">
                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <div class="relative">
                                <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                                <input type="text" id="searchInput" placeholder="Search candidates by name, email..." class="w-full pl-10 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 placeholder-gray-500 focus:outline-none focus:border-emerald-500">
                            </div>
                        </div>
                        <select id="skillLevelSelect" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-emerald-500">
                            <option>All Skill Levels</option>
                            <option>Beginner</option>
                            <option>Novice</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                            <option>Expert</option>
                        </select>
                        <select id="sortOrder" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-300 focus:outline-none focus:border-emerald-500">
                            <option value="name_asc">Name A-Z</option>
                            <option value="name_desc">Name Z-A</option>
                            <option value="score_desc">Highest Score</option>
                            <option value="score_asc">Lowest Score</option>
                            <option value="last_test_desc">Latest Test</option>
                            <option value="last_test_asc">Oldest Test</option>
                        </select>

                    </div>
                </div>

                <!-- Bulk Actions Bar -->
                <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-lg p-4 mb-6 hidden" id="bulkActionsBar">
                    <div class="flex items-center justify-between">
                        <span class="text-emerald-400 font-medium">
                            <span id="selectedCount">0</span> candidates selected
                        </span>
                        <div class="flex items-center space-x-3">
                            <button id="bulkSendEmailBtn" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors text-sm">
                                <i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>Send Email
                            </button>
                            <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-300 rounded-lg transition-colors text-sm">
                                <i data-lucide="user-check" class="w-4 h-4 inline mr-2"></i>Assign Test
                            </button>
                        </div>
                    </div>
                </div>

            <!-- Candidates Table -->
                <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-800/50 border-b border-gray-800">
                                <tr>
                                    <th class="px-6 py-4 text-left">
                                        <input type="checkbox" class="w-4 h-4 rounded border-gray-700 bg-gray-800 text-emerald-500 focus:ring-emerald-500 focus:ring-offset-0" id="selectAll">
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Candidate
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Email
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Skill Level
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Last Test
                                    </th>
<th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
    Score
</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800" id="candidatesTableBody">
                                <!-- Candidates will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="bg-gray-800/50 px-6 py-4 border-t border-gray-800 hidden" id="paginationContainer">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2 text-sm text-gray-400">
                                <span>Show</span>
                                <select class="px-3 py-1 bg-gray-800 border border-gray-700 rounded text-gray-300 focus:outline-none focus:border-emerald-500" id="itemsPerPage">
                                    <option>10</option>
                                    <option>25</option>
                                    <option>50</option>
                                    <option>100</option>
                                </select>
                                <span>entries per page</span>
                            </div>
                            <div class="flex items-center space-x-2" id="paginationButtons">
                                <!-- Pagination buttons will be generated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../config.js";

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase configuration not found');
            document.body.innerHTML = `
                <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                    <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                        <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-2">Configuration Error</h1>
                        <p class="text-gray-300 mb-4 leading-relaxed">Supabase credentials not found.</p>
                    </div>
                </div>`;
        } else {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Helper functions
        function redirectUser(role) {
            const rolePaths = {
                admin: '/admin/users.html',
                recruiter: '/recruiter/dashboard.html',
                candidate: '/candidate/dashboard.html',
            };
            const redirectPath = rolePaths[role] || '/auth/login.html';
            window.location.href = redirectPath;
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        async function protectPage(authorizedRoles = []) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/auth/login.html';
                return null;
            }

            const { data: profile, error } = await supabase
                .from('profiles')
                .select('role, is_role_finalized')
                .eq('id', user.id)
                .single();

            if (error || !profile) {
                console.error('Error fetching profile or profile not found. Redirecting to login.');
                window.location.href = '/auth/login.html';
                return null;
            }

            if (!profile.is_role_finalized) {
                window.location.href = '/auth/role_selection.html';
                return null;
            }

            if (authorizedRoles.length > 0 && !authorizedRoles.includes(profile.role)) {
                document.body.innerHTML = `
                    <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                        <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                            <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-2">Access Denied</h1>
                        <p class="text-gray-300 mb-4 leading-relaxed">
                            You don't have permission to access this page.
                        </p>
                        <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                            <div class="text-sm text-gray-400 mb-1">Your current role:</div>
                            <div class="text-lg font-semibold text-blue-400 capitalize">${profile.role}</div>
                            <div class="text-sm text-gray-400 mt-2 mb-1">Required role(s):</div>
                            <div class="text-lg font-semibold text-yellow-400">${authorizedRoles.join(', ')}</div>
                        </div>
                        <p class="text-gray-500 text-sm">
                            Redirecting you to your dashboard in <span id="countdown" class="text-blue-400 font-semibold">3</span> seconds...
                        </p>
                    </div>
                `;

                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    countdown--;
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        redirectUser(profile.role);
                    }
                }, 1000);

                return null;
            }

            return { user, profile };
        }

        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalCandidates = 0;
        let allCandidates = [];
        let emailMapGlobal = {};
        let levelMapGlobal = {};
        let resultMapGlobal = {};
        let evalMapGlobal = {};
        let averageScoreMapGlobal = {};
        // Filter state
        let searchTerm = '';
        let selectedSkillLevel = 'All Skill Levels';
        let sortOrder = 'name_asc';

        let recruiterUser = null;

        // Protect this page, only 'recruiter' role is authorized
        protectPage(['recruiter']).then(async ({ user, profile }) => {
            if (user && profile) {
                recruiterUser = user;
                // User is authorized, proceed with rendering the candidates page
                lucide.createIcons();

                // Event listener for candidate detail buttons
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.candidate-detail-btn')) {
                        e.preventDefault();
                        const btn = e.target.closest('.candidate-detail-btn');
                        const candidateId = btn.getAttribute('data-candidate-id');
                        if (candidateId) {
                            window.location.href = `candidate-detail.html?id=${candidateId}`;
                        }
                    }
                });

                // Event listener for send email buttons
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.send-email-btn')) {
                        e.preventDefault();
                        const btn = e.target.closest('.send-email-btn');
                        const candidateId = btn.getAttribute('data-candidate-id');
                        if (candidateId) {
                            window.location.href = `send-email.html?id=${candidateId}`;
                        } else {
                            alert('Candidate information not available');
                        }
                    }
                });

                // Initialize pagination controls
                initializePagination();

                // Initialize filters
                initializeFilters();

                // Load candidates data from Supabase
                await loadCandidates(user);

                // For debugging - log user and profile
                console.log('User:', user);
                console.log('Profile:', profile);

                // Bulk selection logic
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.querySelectorAll('.candidate-checkbox');
                const bulkActionsBar = document.getElementById('bulkActionsBar');
                const selectedCount = document.getElementById('selectedCount');

                selectAll.addEventListener('change', function() {
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updateBulkActions();
                });

                checkboxes.forEach(cb => {
                    cb.addEventListener('change', updateBulkActions);
                });

                function updateBulkActions() {
                    const checked = document.querySelectorAll('.candidate-checkbox:checked').length;
                    selectedCount.textContent = checked;
                    bulkActionsBar.classList.toggle('hidden', checked === 0);
                }

                // Event listener for bulk send email
                document.getElementById('bulkSendEmailBtn').addEventListener('click', () => {
                    const selectedCheckboxes = document.querySelectorAll('.candidate-checkbox:checked');
                    const emails = [];
                    selectedCheckboxes.forEach(cb => {
                        const row = cb.closest('tr');
                        const candidateId = row.querySelector('.candidate-detail-btn').getAttribute('data-candidate-id');
                        const email = emailMapGlobal[candidateId];
                        if (email) emails.push(email);
                    });
                    if (emails.length > 0 && recruiterUser && recruiterUser.email) {
                        const subject = 'Regarding Your J-SAT Application';
                        const body = `Dear Candidates,\n\nI hope this email finds you well.\n\nBest regards,\n${recruiterUser.email}`;
                        const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(emails.join(','))}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}&cc=${encodeURIComponent(recruiterUser.email)}`;
                        window.open(gmailUrl, '_blank');
                    } else {
                        alert('No candidates selected or recruiter email not available');
                    }
                });
            }
        });

        async function loadCandidates() {
            const tbody = document.getElementById('candidatesTableBody');
            if (!tbody) return;
            
            // Show loading state
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <div class="flex items-center justify-center space-x-3">
                            <div class="animate-spin rounded-full h-8 w-8 border-2 border-emerald-500 border-t-transparent"></div>
                            <span class="text-gray-400 text-lg">Loading candidates...</span>
                        </div>
                    </td>
                </tr>
            `;
            
            try {
                // Step 1: Fetch candidate profiles
                const { data: candidates, error: candidatesError } = await supabase
                    .from('profiles')
                    .select('id, first_name, last_name')
                    .eq('role', 'candidate');

                if (candidatesError) throw candidatesError;

                // Fetch candidate emails using RPC function
                const { data: emailData, error: emailError } = await supabase
                    .rpc('get_candidate_emails');

                // Create email map for easy lookup
                const emailMap = {};
                if (!emailError && emailData) {
                    emailData.forEach(item => {
                        emailMap[item.user_id] = item.email;
                    });
                }

                // Step 2: Fetch level statuses for candidates
                const candidateIds = candidates.map(c => c.id);
                const { data: levels, error: levelsError } = await supabase
                    .from('level')
                    .select('profile_id, level_status')
                    .in('profile_id', candidateIds);

                if (levelsError) throw levelsError;

                // Step 3: Fetch latest results via evaluation join
                const { data: evaluations, error: evalError } = await supabase
                    .from('evaluation')
                    .select('id, profile_id, created_at, correctness')
                    .in('profile_id', candidateIds)
                    .order('created_at', { ascending: false });

                if (evalError) throw evalError;

                // Group evaluations by profile_id (latest first)
                const evalMap = {};
                evaluations.forEach(eval_record => {
                    if (!evalMap[eval_record.profile_id]) {
                        evalMap[eval_record.profile_id] = eval_record;
                    }
                });

                // Fetch all results for candidates to calculate averages
                const { data: allResults, error: resultsError } = await supabase
                    .from('evaluation')
                    .select('profile_id, result(score)')
                    .in('profile_id', candidateIds);

                if (resultsError) throw resultsError;

                // Calculate average scores per candidate
                const averageScoreMap = {};
                const scoreCounts = {};
                allResults.forEach(eval_record => {
                    const profileId = eval_record.profile_id;
                    if (eval_record.result && eval_record.result.length > 0) {
                        eval_record.result.forEach(res => {
                            if (!averageScoreMap[profileId]) {
                                averageScoreMap[profileId] = 0;
                                scoreCounts[profileId] = 0;
                            }
                            averageScoreMap[profileId] += res.score;
                            scoreCounts[profileId]++;
                        });
                    }
                });

                // Finalize averages
                Object.keys(averageScoreMap).forEach(profileId => {
                    if (scoreCounts[profileId] > 0) {
                        averageScoreMap[profileId] = averageScoreMap[profileId] / scoreCounts[profileId];
                    } else {
                        averageScoreMap[profileId] = 0;
                    }
                });

                // Create maps for data lookup
                const levelMap = {};
                levels.forEach(level => {
                    levelMap[level.profile_id] = level.level_status;
                });

                const resultMap = {};
                allResults.forEach(eval_record => {
                    if (eval_record.result && eval_record.result.length > 0) {
                        eval_record.result.forEach(res => {
                            resultMap[eval_record.id] = res.score;
                        });
                    }
                });

                // Store data globally for pagination
                allCandidates = candidates || [];
                emailMapGlobal = emailMap;
                levelMapGlobal = levelMap;
                resultMapGlobal = resultMap;
                evalMapGlobal = evalMap;
                averageScoreMapGlobal = averageScoreMap;
                totalCandidates = allCandidates.length;

                // Update pagination display
                updatePaginationVisibility();

                // Render candidates with pagination
                renderCandidates();
            } catch (error) {
                console.error('Error loading candidates:', error);
                // Show fallback message if loading fails
                const tbody = document.getElementById('candidatesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-400">
                            <i data-lucide="alert-circle" class="w-8 h-8 inline mr-2"></i>
                            Failed to load candidates. Please try again later.
                        </td>
                    </tr>
                `;
                lucide.createIcons();
            }
        }

        function renderCandidates() {
            // Filter candidates based on search and skill level
            let filteredCandidates = allCandidates.filter(candidate => {
                // Search filter
                const fullName = `${candidate.first_name || ''} ${candidate.last_name || ''}`.toLowerCase();
                const email = emailMapGlobal[candidate.id] || '';
                const matchesSearch = !searchTerm ||
                    fullName.includes(searchTerm) ||
                    email.toLowerCase().includes(searchTerm);

                // Skill level filter
                const skillLevel = levelMapGlobal[candidate.id] || 'Beginner';
                const matchesSkill = selectedSkillLevel === 'All Skill Levels' ||
                    skillLevel === selectedSkillLevel;

                return matchesSearch && matchesSkill;
            });

            // Sort filtered candidates
            filteredCandidates.sort((a, b) => {
                if (sortOrder === 'name_asc') {
                    const nameA = `${a.first_name || ''} ${a.last_name || ''}`.trim();
                    const nameB = `${b.first_name || ''} ${b.last_name || ''}`.trim();
                    return nameA.localeCompare(nameB);
                } else if (sortOrder === 'name_desc') {
                    const nameA = `${a.first_name || ''} ${a.last_name || ''}`.trim();
                    const nameB = `${b.first_name || ''} ${b.last_name || ''}`.trim();
                    return nameB.localeCompare(nameA);
                } else if (sortOrder === 'score_desc') {
                    const scoreA = averageScoreMapGlobal[a.id] || 0;
                    const scoreB = averageScoreMapGlobal[b.id] || 0;
                    return scoreB - scoreA;
                } else if (sortOrder === 'score_asc') {
                    const scoreA = averageScoreMapGlobal[a.id] || 0;
                    const scoreB = averageScoreMapGlobal[b.id] || 0;
                    return scoreA - scoreB;
                } else if (sortOrder === 'last_test_desc') {
                    const evalA = evalMapGlobal[a.id];
                    const evalB = evalMapGlobal[b.id];
                    const dateA = evalA ? new Date(evalA.created_at) : new Date(0);
                    const dateB = evalB ? new Date(evalB.created_at) : new Date(0);
                    return dateB - dateA;
                } else if (sortOrder === 'last_test_asc') {
                    const evalA = evalMapGlobal[a.id];
                    const evalB = evalMapGlobal[b.id];
                    const dateA = evalA ? new Date(evalA.created_at) : new Date(0);
                    const dateB = evalB ? new Date(evalB.created_at) : new Date(0);
                    return dateA - dateB;
                }
                return 0;
            });

            // Update total candidates count for pagination
            totalCandidates = filteredCandidates.length;
            updatePaginationVisibility();

            // Check if current page is valid after filtering
            const totalPages = Math.ceil(totalCandidates / itemsPerPage);
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }

            const tbody = document.getElementById('candidatesTableBody');
            tbody.innerHTML = ''; // Clear existing rows

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalCandidates);
            const candidatesToShow = filteredCandidates.slice(startIndex, endIndex);

            const skillLevelColors = {
                'Beginner': 'bg-yellow-500/10 text-yellow-500',
                'Novice': 'bg-blue-500/10 text-blue-500',
                'Intermediate': 'bg-purple-500/10 text-purple-500',
                'Advanced': 'bg-emerald-500/10 text-emerald-500',
                'Expert': 'bg-red-500/10 text-red-500'
            };

            const randomColors = ['ef4444', 'f97316', 'eab308', '22c55e', '06b6d4', '3b82f6', '8b5cf6', 'ec4899'];

            candidatesToShow.forEach((candidate, index) => {
                const skillLevel = levelMapGlobal[candidate.id] || 'Beginner';
                const latestEval = evalMapGlobal[candidate.id];
                const score = averageScoreMapGlobal[candidate.id] || 0;
                const lastTest = latestEval ? formatTimeAgo(new Date(latestEval.created_at)) : 'Never';
                // Random color for avatar
                const randomColor = randomColors[Math.floor(Math.random() * randomColors.length)];
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent((candidate.first_name || '') + ' ' + (candidate.last_name || ''))}&background=${randomColor}&color=fff`;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800/30 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="candidate-checkbox w-4 h-4 rounded border-gray-700 bg-gray-800 text-emerald-500 focus:ring-emerald-500 focus:ring-offset-0">
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-3">
                            <img src="${avatarUrl}" alt="Avatar" class="w-10 h-10 rounded-full">
                            <div>
                                <p class="text-sm font-medium text-white">${candidate.first_name || ''} ${candidate.last_name || ''}</p>
                                <p class="text-xs text-gray-500">ID: #${candidate.id.slice(-4).toUpperCase()}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-300">${emailMapGlobal[candidate.id] || 'Email not available'}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${skillLevelColors[skillLevel] || skillLevelColors['Beginner']}">
                            ${skillLevel}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-400">${lastTest}</td>
                    <td class="px-6 py-4">
                        <span class="text-gray-300">${score.toFixed(1)}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <button class="p-2 hover:bg-gray-800 rounded-lg transition-colors candidate-detail-btn" title="View Details" data-candidate-id="${candidate.id}">
                                <i data-lucide="eye" class="w-4 h-4 text-gray-400"></i>
                            </button>
                            <button class="send-email-btn p-2 hover:bg-gray-800 rounded-lg transition-colors" title="Send Email" data-candidate-id="${candidate.id}">
                                <i data-lucide="mail" class="w-4 h-4 text-gray-400"></i>
                            </button>
                            <button class="p-2 hover:bg-gray-800 rounded-lg transition-colors" title="More">
                                <i data-lucide="more-vertical" class="w-4 h-4 text-gray-400"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });

            // Re-initialize icons for new elements
            lucide.createIcons();

            // Update pagination UI
            generatePaginationButtons();
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInHours = diffInMs / (1000 * 60 * 60);
            const diffInDays = diffInHours / 24;
            const diffInWeeks = diffInDays / 7;

            if (diffInHours < 1) {
                const minutes = Math.floor(diffInMs / (1000 * 60));
                return `${minutes} min ago`;
            } else if (diffInHours < 24) {
                return `${Math.floor(diffInHours)} hours ago`;
            } else if (diffInDays < 7) {
                return `${Math.floor(diffInDays)} days ago`;
            } else {
                return `${Math.floor(diffInWeeks)} weeks ago`;
            }
        }

        function initializePagination() {
            // Set up event listener for items per page select
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            itemsPerPageSelect.value = itemsPerPage.toString();
            itemsPerPageSelect.addEventListener('change', function() {
                itemsPerPage = parseInt(this.value);
                currentPage = 1; // Reset to first page
                if (allCandidates.length > 0) {
                    updatePaginationVisibility();
                    renderCandidates();
                }
            });
        }

        function updatePaginationVisibility() {
            const paginationContainer = document.getElementById('paginationContainer');
            // Show pagination only if there are more candidates than items per page
            if (totalCandidates > itemsPerPage) {
                paginationContainer.classList.remove('hidden');
            } else {
                paginationContainer.classList.add('hidden');
            }
        }

        function initializeFilters() {
            // Set up event listener for search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                searchTerm = this.value.trim().toLowerCase();
                currentPage = 1; // Reset to first page
                if (allCandidates.length > 0) {
                    renderCandidates();
                }
            });

            // Set up event listener for skill level select
            const skillLevelSelect = document.getElementById('skillLevelSelect');
            skillLevelSelect.value = selectedSkillLevel;
            skillLevelSelect.addEventListener('change', function() {
                selectedSkillLevel = this.value;
                currentPage = 1; // Reset to first page
                if (allCandidates.length > 0) {
                    renderCandidates();
                }
            });

            // Set up event listener for sort order select
            const sortOrderSelect = document.getElementById('sortOrder');
            sortOrderSelect.value = sortOrder;
            sortOrderSelect.addEventListener('change', function() {
                sortOrder = this.value;
                currentPage = 1; // Reset to first page
                if (allCandidates.length > 0) {
                    renderCandidates();
                }
            });
        }

        function generatePaginationButtons() {
            const paginationButtons = document.getElementById('paginationButtons');
            const totalPages = Math.ceil(totalCandidates / itemsPerPage);

            // Clear existing buttons
            paginationButtons.innerHTML = '';

            // Previous button
            const prevButton = document.createElement('button');
            prevButton.className = `px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors disabled:opacity-50 ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : ''}`;
            prevButton.innerHTML = '<i data-lucide="chevron-left" class="w-4 h-4"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCandidates();
                }
            });
            paginationButtons.appendChild(prevButton);

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Show first page if not in range
            if (startPage > 1) {
                const firstPageBtn = createPageButton(1);
                paginationButtons.appendChild(firstPageBtn);
            }

            // Generate page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = createPageButton(i);
                if (i === currentPage) {
                    pageButton.className = 'px-4 py-2 bg-emerald-500 text-white rounded-lg';
                }
                paginationButtons.appendChild(pageButton);
            }

            // Show last page if not in range
            if (endPage < totalPages) {
                const lastPageBtn = createPageButton(totalPages);
                paginationButtons.appendChild(lastPageBtn);
            }

            // Next button
            const nextButton = document.createElement('button');
            nextButton.className = `px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors disabled:opacity-50 ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : ''}`;
            nextButton.innerHTML = '<i data-lucide="chevron-right" class="w-4 h-4"></i>';
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCandidates();
                }
            });
            paginationButtons.appendChild(nextButton);

            // Re-initialize icons
            lucide.createIcons();
        }

        function createPageButton(pageNumber) {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors';
            button.textContent = pageNumber;
            button.addEventListener('click', () => {
                currentPage = pageNumber;
                renderCandidates();
            });
            return button;
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = '/jsat/app/auth/login.html';
        });
        }
    </script>
</body>
</html>
