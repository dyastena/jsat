<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - JSAT Recruiter Panel</title>
    <link href="/dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30">
                        <i data-lucide="satellite" class="w-7 h-7 text-white"></i>
                    </div>
                    <span class="text-2xl font-bold text-white">J-SAT</span>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="candidates.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Candidates</span>
                </a>

                <a href="reports-analytics.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-emerald-500/10 text-emerald-500 transition-colors">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Analytics</span>
                </a>
                <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors w-full">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Reports & Analytics</h2>
                        <p class="text-gray-400 mt-1">Performance insights and detailed reporting</p>
                    </div>
                    <div class="flex items-center space-x-3">

                    </div>
                </div>
            </header>

            <div class="p-8 space-y-6 max-w-full overflow-hidden">
                <!-- Reports Table -->
                <div class="bg-gray-900 rounded-xl border border-gray-800">
                    <div class="p-6 border-b border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Candidate Reports</h3>
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                                    <input type="text" placeholder="Search reports..." class="pl-9 pr-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-300 placeholder-gray-500 focus:outline-none focus:border-emerald-500">
                                </div>
                                <select id="skillLevelFilter" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-300 focus:outline-none focus:border-emerald-500">
                                    <option>All Levels</option>
                                    <option>Beginner</option>
                                    <option>Novice</option>
                                    <option>Intermediate</option>
                                    <option>Advanced</option>
                                    <option>Expert</option>
                                </select>
                                <select id="sortOrder" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-300 focus:outline-none focus:border-emerald-500">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="score_desc">Highest Score</option>
                                    <option value="score_asc">Lowest Score</option>
                                    <option value="name_asc">Name A-Z</option>
                                    <option value="name_desc">Name Z-A</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-w-full">
                        <table class="w-full min-w-[800px]">
                            <thead class="bg-gray-800/50 border-b border-gray-800">
<tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Candidate</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Test Date</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Score</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Skill Level</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">cart_eval</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <!-- Dynamically populated from Supabase -->
                            </tbody>
                        </table>
                    </div>

                <!-- Pagination -->
                <div class="bg-gray-800/50 px-6 py-4 border-t border-gray-800">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400 pagination-info">Showing 1-10 of 0 reports</span>
                        <div class="flex items-center space-x-2 pagination-nav">
                            <button class="px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors disabled:opacity-50 pagination-prev" disabled>
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <div class="flex items-center space-x-1 pagination-buttons">
                                <!-- Pagination buttons will be generated dynamically -->
                            </div>
                            <button class="px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors disabled:opacity-50 pagination-next">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-500/10 rounded-lg">
                                <i data-lucide="users-2" class="w-6 h-6 text-blue-500"></i>
                            </div>
                            <span class="text-xs font-medium text-blue-500">+18%</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1 total-tests">0</h3>
                        <p class="text-sm text-gray-400">Total Tests Completed</p>
                    </div>

                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-emerald-500/10 rounded-lg">
                                <i data-lucide="target" class="w-6 h-6 text-emerald-500"></i>
                            </div>
                            <span class="text-xs font-medium text-emerald-500">+5%</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1 avg-score">0.0%</h3>
                        <p class="text-sm text-gray-400">Average Score</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Performance Trends -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold text-white mb-6">Performance Trends</h3>
                        <div class="w-full h-64 overflow-hidden">
                            <canvas id="performanceChart" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <!-- Skill Gap Analysis -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold text-white mb-6">Skill Gap Analysis</h3>
                        <div class="w-full h-64 overflow-hidden">
                            <canvas id="skillGapChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../config.js";

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase configuration not found');
            document.body.innerHTML = `
                <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                    <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                        <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-2">Configuration Error</h1>
                        <p class="text-gray-300 mb-4 leading-relaxed">Supabase credentials not found.</p>
                    </div>
                </div>`;
        } else {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Helper functions
        function redirectUser(role) {
            const rolePaths = {
                admin: '/admin/users.html',
                recruiter: '/recruiter/dashboard.html',
                candidate: '/candidate/dashboard.html',
            };
            const redirectPath = rolePaths[role] || '/auth/login.html';
            window.location.href = redirectPath;
        }

        async function logout() {
            await supabase.auth.signOut();
        }

        async function protectPage(authorizedRoles = []) {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                window.location.href = '/jsat/app/auth/login.html';
                return null;
            }

            const { data: profile, error } = await supabase
                .from('profiles')
                .select('role, is_role_finalized')
                .eq('id', user.id)
                .single();

            if (error || !profile) {
                console.error('Error fetching profile or profile not found. Redirecting to login.');
                window.location.href = '/jsat/app/auth/login.html';
                return null;
            }

            if (!profile.is_role_finalized) {
                window.location.href = '/jsat/app/auth/role_selection.html';
                return null;
            }

            if (authorizedRoles.length > 0 && !authorizedRoles.includes(profile.role)) {
                document.body.innerHTML = `
                    <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                        <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                            <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-red-400 mb-2">Access Denied</h1>
                    <p class="text-gray-300 mb-4 leading-relaxed">
                        You don't have permission to access this page.
                    </p>
                    <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                        <div class="text-sm text-gray-400 mb-1">Your current role:</div>
                        <div class="text-lg font-semibold text-blue-400 capitalize">${profile.role}</div>
                        <div class="text-sm text-gray-400 mt-2 mb-1">Required role(s):</div>
                        <div class="text-lg font-semibold text-yellow-400">${authorizedRoles.join(', ')}</div>
                    </div>
                    <p class="text-gray-500 text-sm">
                        Redirecting you to your dashboard in <span id="countdown" class="text-blue-400 font-semibold">3</span> seconds...
                    </p>
                </div>
                `;

                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    countdown--;
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        redirectUser(profile.role);
                    }
                }, 1000);

                return null;
            }

            return { user, profile };
        }

        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalItems = 0;

        // Protect this page, only 'recruiter' role is authorized
        protectPage(['recruiter']).then(({ user, profile }) => {
            if (user && profile) {
                // User is authorized, proceed with rendering the reports page
                lucide.createIcons();

                // Fetch analytics data
                loadAnalyticsData();

                // Initialize charts
                loadChartsData();

                // Initialize sort order event listener
                document.getElementById('sortOrder').addEventListener('change', () => {
                    currentPage = 1; // Reset to first page
                    loadAnalyticsData();
                });

                // Initialize skill level filter event listener
                document.getElementById('skillLevelFilter').addEventListener('change', () => {
                    currentPage = 1; // Reset to first page
                    loadAnalyticsData();
                });
            }
        });

        async function loadAnalyticsData() {
            try {
                const sortOrder = document.getElementById('sortOrder').value;
                const skillLevelFilter = document.getElementById('skillLevelFilter').value;

                // Fetch summary stats
                const { data: summaryData } = await supabase
                    .from('result')
                    .select('score');

                let totalTests = 0;
                let avgScore = 0;

                if (summaryData && summaryData.length > 0) {
                    totalTests = summaryData.length;
                    avgScore = summaryData.reduce((sum, item) => sum + (item.score || 0), 0) / totalTests;
                }

                // Update summary cards
                const totalTestsEl = document.querySelector('.total-tests');
                const avgScoreEl = document.querySelector('.avg-score');

                if (totalTestsEl) {
                    totalTestsEl.textContent = totalTests.toLocaleString();
                }
                if (avgScoreEl) {
                    avgScoreEl.textContent = `${(avgScore * 10).toFixed(1)}%`;
                }

                // Hide pagination nav if fewer than 10 reports
                const paginationNav = document.querySelector('.pagination-nav');
                if (paginationNav && totalTests < 10) {
                    paginationNav.style.display = 'none';
                } else if (paginationNav) {
                    paginationNav.style.display = 'flex';
                }

                // Map skill level filter to cart_eval values
                const levelMapping = {
                    'Beginner': 'FOUNDATION',
                    'Novice': 'BASIC',
                    'Intermediate': 'PROFICIENT',
                    'Advanced': 'ADVANCED',
                    'Expert': 'MASTERY'
                };
                const targetCartEval = levelMapping[skillLevelFilter];

                // Determine order for query
                let orderColumn = 'created_at';
                let ascending = false;

                if (sortOrder === 'oldest') {
                    ascending = true;
                } else if (sortOrder === 'score_desc') {
                    orderColumn = 'score';
                    ascending = false;
                } else if (sortOrder === 'score_asc') {
                    orderColumn = 'score';
                    ascending = true;
                }

                // Get filtered count first for pagination
                let countQuery = supabase
                    .from('result')
                    .select('id', { count: 'exact', head: true });

                if (targetCartEval) {
                    countQuery = countQuery.eq('cart_eval', targetCartEval);
                }

                const { count } = await countQuery;
                totalItems = count || 0;

                // Fetch table data with pagination
                const offset = (currentPage - 1) * itemsPerPage;
                let query = supabase
                    .from('result')
                    .select(`
                        score,
                        cart_eval,
                        created_at,
                        evaluation!inner (
                            profile_id,
                            question_id,
                            question (
                                difficulty
                            )
                        )
                    `)
                    .order(orderColumn, { ascending })
                    .range(offset, offset + itemsPerPage - 1);

                // Apply skill level filter if selected
                if (targetCartEval) {
                    query = query.eq('cart_eval', targetCartEval);
                }

                const { data: tableData } = await query;

                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';

                if (tableData && tableData.length > 0) {
                    // Collect profile IDs
                    const profileIds = tableData.map(item => item.evaluation.profile_id);

                    // Fetch profiles in batch
                    const { data: profiles } = await supabase
                        .from('profiles')
                        .select('id, first_name, last_name')
                        .in('id', profileIds);

                    // Fetch emails
                    const { data: emails } = await supabase.rpc('get_candidate_emails');

                    const profileMap = {};
                    const emailMap = {};
                    profiles.forEach(p => {
                        profileMap[p.id] = `${p.first_name || ''} ${p.last_name || ''}`.trim();
                    });
                    emails.forEach(e => {
                        emailMap[e.user_id] = e.email;
                    });

                    // Sort by name if needed
                    if (sortOrder === 'name_asc' || sortOrder === 'name_desc') {
                        tableData.sort((a, b) => {
                            const nameA = profileMap[a.evaluation.profile_id] || '';
                            const nameB = profileMap[b.evaluation.profile_id] || '';
                            if (sortOrder === 'name_asc') {
                                return nameA.localeCompare(nameB);
                            } else {
                                return nameB.localeCompare(nameA);
                            }
                        });
                    }

                    for (const item of tableData) {
                        const fullname = profileMap[item.evaluation.profile_id] || 'N/A';
                        const email = emailMap[item.evaluation.profile_id] || 'N/A';
                        const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullname)}&background=10b981&color=fff`;
                        const date = new Date(item.created_at).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });

                        const levelColors = {
                            FOUNDATION: 'bg-blue-500/10 text-blue-500',
                            BASIC: 'bg-green-500/10 text-green-500',
                            PROFICIENT: 'bg-yellow-500/10 text-yellow-500',
                            ADVANCED: 'bg-purple-500/10 text-purple-500',
                            MASTERY: 'bg-red-500/10 text-red-500'
                        };
                        const cartColor = levelColors[item.cart_eval] || 'bg-gray-500/10 text-gray-500';

                        const row = `
                            <tr class="hover:bg-gray-800/30 transition-colors">
                                <td class="px-6 py-4">
                                    <div class="flex items-center space-x-3">
                                        <img src="${avatar}" alt="Avatar" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="text-sm font-medium text-white">${fullname}</p>
                                            <p class="text-xs text-gray-500">${email}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-300">${date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-white mr-2">${(item.score || 0).toFixed(1)}</span>
                                        <div class="w-16 h-2 bg-gray-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-emerald-500" style="width: ${(item.score || 0) * 10}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-500">${item.evaluation.question?.difficulty || 'Unknown'}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${cartColor}">${item.cart_eval}</span>
                                </td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    }

                    // Update pagination
                    updatePaginationInfo();
                    generatePaginationButtons();
                } else {
                    // No data case
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">No candidate reports found.</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-red-400">Error loading data. Please try again.</td>
                    </tr>
                `;
            }
        }

        async function loadChartsData() {
            try {
                // Fetch performance trends data - daily average scores from recent 30 days
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const { data: trendsData } = await supabase
                    .from('result')
                    .select('score, created_at')
                    .gte('created_at', thirtyDaysAgo.toISOString())
                    .order('created_at', { ascending: true });

                // If no trend data, use default
                const trendLabels = [];
                let trendData = [];

                if (trendsData && trendsData.length > 0) {
                    // Group by day and calculate averages
                    const dailyData = {};
                    trendsData.forEach(item => {
                        const date = new Date(item.created_at);
                        const dayKey = date.toISOString().split('T')[0]; // YYYY-MM-DD
                        if (!dailyData[dayKey]) {
                            dailyData[dayKey] = [];
                        }
                        dailyData[dayKey].push(item.score || 0);
                    });

                    trendLabels.length = 0;
                    trendData.length = 0;
                    // Sort days
                    const sortedDays = Object.keys(dailyData).sort();

                    sortedDays.forEach(day => {
                        const scores = dailyData[day];
                        const avg = scores.reduce((a,b) => a + b, 0) / scores.length;
                        // Format date for display (MM/DD)
                        const date = new Date(day);
                        const label = `${date.getMonth() + 1}/${date.getDate()}`;
                        trendLabels.push(label);
                        trendData.push(Math.round(avg * 10));
                    });

                    // If no data, fall back to defaults
                    if (trendData.length === 0) {
                        trendLabels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                        trendData = [68, 71, 74, 76, 79, 82, 85];
                    }
                } else {
                    // Default data when no database data
                    trendLabels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
                    trendData = [68, 71, 74, 76, 79, 82, 85];
                }

                // Performance Trends Chart
                const perfCtx = document.getElementById('performanceChart').getContext('2d');
                new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Average Score',
                            data: trendData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(75, 85, 99, 0.2)' },
                                ticks: { color: '#9ca3af' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#9ca3af' }
                            }
                        }
                    }
                });

                // Fetch skill gap data - average evaluation factors directly
                const { data: skillData } = await supabase
                    .from('evaluation')
                    .select('correctness, line_code, time_taken, runtime, error_made, created_at')
                    .order('created_at', { ascending: false })
                    .limit(100);

                let factorDataArr = [0, 0, 0, 0, 0]; // default to 0 if no data

                if (skillData && skillData.length > 0) {
                    // Calculate averages for each of the 5 evaluation factors
                    // Note: time_taken and error_made are inverted since lower values are better
                    const correctnessList = skillData.map(item => item.correctness || 0).filter(x => x > 0);
                    const lineCodeList = skillData.map(item => item.line_code || 0).filter(x => x > 0);
                    const timeTakenList = skillData.map(item => item.time_taken ? Math.max(0, 10 - item.time_taken) : 0).filter(x => x > 0);
                    const runtimeList = skillData.map(item => item.runtime || 0).filter(x => x > 0);
                    const errorMadeList = skillData.map(item => item.error_made ? Math.max(0, 10 - item.error_made) : 0).filter(x => x > 0);

                    const avgCorrectness = correctnessList.length > 0 ? correctnessList.reduce((a,b) => a+b, 0) / correctnessList.length : 0;
                    const avgLineCode = lineCodeList.length > 0 ? lineCodeList.reduce((a,b) => a+b, 0) / lineCodeList.length : 0;
                    const avgTimeEfficiency = timeTakenList.length > 0 ? timeTakenList.reduce((a,b) => a+b, 0) / timeTakenList.length : 0;
                    const avgRuntime = runtimeList.length > 0 ? runtimeList.reduce((a,b) => a+b, 0) / runtimeList.length : 0;
                    const avgErrorHandling = errorMadeList.length > 0 ? errorMadeList.reduce((a,b) => a+b, 0) / errorMadeList.length : 0;

                    factorDataArr = [
                        Math.round(avgCorrectness * 10),
                        Math.round(avgLineCode * 10),
                        Math.round(avgTimeEfficiency * 10),
                        Math.round(avgRuntime * 10),
                        Math.round(avgErrorHandling * 10)
                    ];
                }

                // Skill Gap Chart (now based on 5 evaluation factors)
                const gapCtx = document.getElementById('skillGapChart').getContext('2d');
                new Chart(gapCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Correctness', 'Code Quality', 'Time Efficiency', 'Runtime Efficiency', 'Error Handling'],
                        datasets: [{
                            label: 'Average Proficiency',
                            data: factorDataArr,
                            borderColor: 'rgb(168, 85, 247)',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(75, 85, 99, 0.2)' },
                                ticks: { color: '#9ca3af', backdropColor: 'transparent' },
                                pointLabels: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Pagination functions
        function updatePaginationInfo() {
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            const paginationInfoEl = document.querySelector('.pagination-info');

            if (paginationInfoEl) {
                paginationInfoEl.textContent = `Showing ${startItem}-${endItem} of ${totalItems} reports`;
            }
        }

        function generatePaginationButtons() {
            const paginationButtonsEl = document.querySelector('.pagination-buttons');
            const prevBtn = document.querySelector('.pagination-prev');
            const nextBtn = document.querySelector('.pagination-next');

            if (!paginationButtonsEl) return;

            // Clear existing buttons
            paginationButtonsEl.innerHTML = '';

            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const maxVisiblePages = 5;

            // Enable/disable prev/next buttons
            if (prevBtn) {
                prevBtn.disabled = currentPage <= 1;
                prevBtn.classList.toggle('opacity-50', currentPage <= 1);
                prevBtn.classList.toggle('cursor-not-allowed', currentPage <= 1);
            }
            if (nextBtn) {
                nextBtn.disabled = currentPage >= totalPages;
                nextBtn.classList.toggle('opacity-50', currentPage >= totalPages);
                nextBtn.classList.toggle('cursor-not-allowed', currentPage >= totalPages);
            }

            // Calculate page range to show
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Add first page if not in range
            if (startPage > 1) {
                const firstBtn = createPageButton(1);
                paginationButtonsEl.appendChild(firstBtn);

                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-2 text-gray-400';
                    ellipsis.textContent = '...';
                    paginationButtonsEl.appendChild(ellipsis);
                }
            }

            // Generate page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i);
                if (i === currentPage) {
                    pageBtn.className = 'px-4 py-2 bg-emerald-500 text-white rounded-lg font-semibold';
                }
                paginationButtonsEl.appendChild(pageBtn);
            }

            // Add last page if not in range
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'px-2 py-2 text-gray-400';
                    ellipsis.textContent = '...';
                    paginationButtonsEl.appendChild(ellipsis);
                }

                const lastBtn = createPageButton(totalPages);
                paginationButtonsEl.appendChild(lastBtn);
            }

            // Add event listeners
            if (prevBtn && !prevBtn.hasEventListener) {
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        loadAnalyticsData();
                    }
                });
                prevBtn.hasEventListener = true;
            }

            if (nextBtn && !nextBtn.hasEventListener) {
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadAnalyticsData();
                    }
                });
                nextBtn.hasEventListener = true;
            }
        }

        function createPageButton(pageNumber) {
            const button = document.createElement('button');
            button.className = 'px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors';
            button.textContent = pageNumber;
            button.addEventListener('click', () => {
                currentPage = pageNumber;
                loadAnalyticsData();
            });
            return button;
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = '/jsat/app/auth/login.html';
        });
        }
    </script>
</body>
</html>
