<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - JSAT Recruiter Panel</title>
    <link href="../../dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="code-2" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">J-SAT</h1>
                        <p class="text-xs text-gray-400">Recruiter Panel</p>
                    </div>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-1">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="candidates.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-medium">Candidates</span>
                </a>

                <a href="reports-analytics.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg bg-emerald-500/10 text-emerald-500 transition-colors">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Analytics</span>
                </a>
                <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="flex items-center space-x-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-gray-800 hover:text-white transition-colors w-full">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Reports & Analytics</h2>
                        <p class="text-gray-400 mt-1">Performance insights and detailed reporting</p>
                    </div>
                    <div class="flex items-center space-x-3">

                    </div>
                </div>
            </header>

            <div class="p-8 space-y-6 max-w-full overflow-hidden">
                <!-- Reports Table -->
                <div class="bg-gray-900 rounded-xl border border-gray-800">
                    <div class="p-6 border-b border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Candidate Reports</h3>
                            <div class="flex items-center space-x-3">
                                <div class="relative">
                                    <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                                    <input type="text" placeholder="Search reports..." class="pl-9 pr-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-300 placeholder-gray-500 focus:outline-none focus:border-emerald-500">
                                </div>
                                <select class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm text-gray-300 focus:outline-none focus:border-emerald-500">
                                    <option>All Levels</option>
                                    <option>Beginner</option>
                                    <option>Novice</option>
                                    <option>Intermediate</option>
                                    <option>Advanced</option>
                                    <option>Expert</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto max-w-full">
                        <table class="w-full min-w-[800px]">
                            <thead class="bg-gray-800/50 border-b border-gray-800">
<tr>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Candidate</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Test Date</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Score</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Skill Level</th>
                                    <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">cart_eval</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                <!-- Dynamically populated from Supabase -->
                            </tbody>
                        </table>
                    </div>

                <!-- Pagination -->
                <div class="bg-gray-800/50 px-6 py-4 border-t border-gray-800">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-400 pagination">Showing 1-10 of 0 reports</span>
                        <div class="flex items-center space-x-2 pagination-nav">
                                <button class="px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors disabled:opacity-50" disabled>
                                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                                </button>
                                <button class="px-4 py-2 bg-emerald-500 text-white rounded-lg">1</button>
                                <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors">2</button>
                                <button class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors">3</button>
                                <button class="px-3 py-2 bg-gray-800 hover:bg-gray-700 text-gray-400 rounded-lg transition-colors">
                                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-blue-500/10 rounded-lg">
                                <i data-lucide="users-2" class="w-6 h-6 text-blue-500"></i>
                            </div>
                            <span class="text-xs font-medium text-blue-500">+18%</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1 total-tests">0</h3>
                        <p class="text-sm text-gray-400">Total Tests Completed</p>
                    </div>

                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <div class="flex items-center justify-between mb-4">
                            <div class="p-3 bg-emerald-500/10 rounded-lg">
                                <i data-lucide="target" class="w-6 h-6 text-emerald-500"></i>
                            </div>
                            <span class="text-xs font-medium text-emerald-500">+5%</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-1 avg-score">0.0%</h3>
                        <p class="text-sm text-gray-400">Average Score</p>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Performance Trends -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold text-white mb-6">Performance Trends</h3>
                        <div class="w-full h-64 overflow-hidden">
                            <canvas id="performanceChart" class="w-full h-full"></canvas>
                        </div>
                    </div>

                    <!-- Skill Gap Analysis -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-lg font-semibold text-white mb-6">Skill Gap Analysis</h3>
                        <div class="w-full h-64 overflow-hidden">
                            <canvas id="skillGapChart" class="w-full h-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { protectPage } from '../js/guard.js';
        import { logout, supabase } from '../js/auth.js';

        // Protect this page, only 'recruiter' role is authorized
        protectPage(['recruiter']).then(({ user, profile }) => {
            if (user && profile) {
                // User is authorized, proceed with rendering the reports page
                lucide.createIcons();

                // Fetch analytics data
                loadAnalyticsData();

                // Initialize charts
                loadChartsData();
            }
        });

        async function loadAnalyticsData() {
            try {
                // Fetch summary stats
                const { data: summaryData } = await supabase
                    .from('result')
                    .select('score');

                let totalTests = 0;
                let avgScore = 0;

                if (summaryData && summaryData.length > 0) {
                    totalTests = summaryData.length;
                    avgScore = summaryData.reduce((sum, item) => sum + (item.score || 0), 0) / totalTests;
                }

                // Update summary cards
                const totalTestsEl = document.querySelector('.total-tests');
                const avgScoreEl = document.querySelector('.avg-score');

                if (totalTestsEl) {
                    totalTestsEl.textContent = totalTests.toLocaleString();
                }
                if (avgScoreEl) {
                    avgScoreEl.textContent = `${(avgScore * 10).toFixed(1)}%`;
                }

                // Hide pagination nav if fewer than 10 reports
                const paginationNav = document.querySelector('.pagination-nav');
                if (paginationNav && totalTests < 10) {
                    paginationNav.style.display = 'none';
                } else if (paginationNav) {
                    paginationNav.style.display = 'flex';
                }

                // Fetch table data
                const { data: tableData } = await supabase
                    .from('result')
                    .select(`
                        score,
                        cart_eval,
                        created_at,
                        evaluation!inner (
                            profile_id,
                            question_id,
                            question (
                                difficulty
                            )
                        )
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);

                const tbody = document.querySelector('tbody');
                tbody.innerHTML = '';

                if (tableData && tableData.length > 0) {
                    // Collect profile IDs
                    const profileIds = tableData.map(item => item.evaluation.profile_id);

                    // Fetch profiles in batch
                    const { data: profiles } = await supabase
                        .from('profiles')
                        .select('id, first_name, last_name')
                        .in('id', profileIds);

                    // Fetch emails
                    const { data: emails } = await supabase.rpc('get_candidate_emails');

                    const profileMap = {};
                    const emailMap = {};
                    profiles.forEach(p => {
                        profileMap[p.id] = `${p.first_name || ''} ${p.last_name || ''}`.trim();
                    });
                    emails.forEach(e => {
                        emailMap[e.user_id] = e.email;
                    });

                    for (const item of tableData) {
                        const fullname = profileMap[item.evaluation.profile_id] || 'N/A';
                        const email = emailMap[item.evaluation.profile_id] || 'N/A';
                        const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullname)}&background=10b981&color=fff`;
                        const date = new Date(item.created_at).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });

                        const levelColors = {
                            FOUNDATION: 'bg-blue-500/10 text-blue-500',
                            BASIC: 'bg-green-500/10 text-green-500',
                            PROFICIENT: 'bg-yellow-500/10 text-yellow-500',
                            ADVANCED: 'bg-purple-500/10 text-purple-500',
                            MASTERY: 'bg-red-500/10 text-red-500'
                        };
                        const cartColor = levelColors[item.cart_eval] || 'bg-gray-500/10 text-gray-500';

                        const row = `
                            <tr class="hover:bg-gray-800/30 transition-colors">
                                <td class="px-6 py-4 cursor-pointer" title="View Candidate Details">
                                    <div class="flex items-center space-x-3">
                                        <img src="${avatar}" alt="Avatar" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="text-sm font-medium text-white">${fullname}</p>
                                            <p class="text-xs text-gray-500">${email}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-300">${date}</td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-white mr-2">${(item.score || 0).toFixed(1)}</span>
                                        <div class="w-16 h-2 bg-gray-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-emerald-500" style="width: ${(item.score || 0) * 10}%"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-500">${item.evaluation.question?.difficulty || 'Unknown'}</span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${cartColor}">${item.cart_eval}</span>
                                </td>
                            </tr>
                        `;
                        tbody.insertAdjacentHTML('beforeend', row);
                    }

                    // Update pagination
                    const paginationSpan = document.querySelector('.pagination');
                    if (paginationSpan) {
                        paginationSpan.textContent = `Showing 1-${Math.min(tableData.length, 10)} of ${totalTests} reports`;
                    }
                } else {
                    // No data case
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-400">No candidate reports found.</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-red-400">Error loading data. Please try again.</td>
                    </tr>
                `;
            }
        }

        async function loadChartsData() {
            try {
                // Fetch performance trends data - monthly average scores from recent results
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                const { data: trendsData } = await supabase
                    .from('result')
                    .select('score, created_at')
                    .gte('created_at', sixMonthsAgo.toISOString())
                    .order('created_at', { ascending: true });

                // If no trend data, use default
                const trendLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                let trendData = [72, 75, 78, 76, 79, 82];

                if (trendsData && trendsData.length > 0) {
                    // Group by month and calculate averages
                    const monthlyData = {};
                    trendsData.forEach(item => {
                        const date = new Date(item.created_at);
                        const monthKey = date.toLocaleString('en-US', { month: 'short' });
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = [];
                        }
                        monthlyData[monthKey].push(item.score || 0);
                    });

                    trendLabels.length = 0;
                    trendData.length = 0;
                    // Only include months with data, sorted by month order
                    const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const monthsKeys = Object.keys(monthlyData).sort((a,b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));

                    // Limit to last 6 months with data
                    const recentMonths = monthsKeys.slice(-6);

                    recentMonths.forEach(month => {
                        const scores = monthlyData[month];
                        const avg = scores.reduce((a,b) => a + b, 0) / scores.length;
                        trendLabels.push(month);
                        trendData.push(Math.round(avg * 10));
                    });

                    // If no data, fall back to defaults
                    if (trendData.length === 0) {
                        trendLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                        trendData = [68, 71, 74, 76, 79, 82];
                    }
                }

                // Performance Trends Chart
                const perfCtx = document.getElementById('performanceChart').getContext('2d');
                new Chart(perfCtx, {
                    type: 'line',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Average Score',
                            data: trendData,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(75, 85, 99, 0.2)' },
                                ticks: { color: '#9ca3af' }
                            },
                            x: {
                                grid: { display: false },
                                ticks: { color: '#9ca3af' }
                            }
                        }
                    }
                });

                // Fetch skill gap data - average evaluation factors directly
                const { data: skillData } = await supabase
                    .from('evaluation')
                    .select('correctness, line_code, time_taken, runtime, error_made, created_at')
                    .order('created_at', { ascending: false })
                    .limit(100);

                let factorDataArr = [0, 0, 0, 0, 0]; // default to 0 if no data

                if (skillData && skillData.length > 0) {
                    // Calculate averages for each of the 5 evaluation factors
                    // Note: time_taken and error_made are inverted since lower values are better
                    const correctnessList = skillData.map(item => item.correctness || 0).filter(x => x > 0);
                    const lineCodeList = skillData.map(item => item.line_code || 0).filter(x => x > 0);
                    const timeTakenList = skillData.map(item => item.time_taken ? Math.max(0, 10 - item.time_taken) : 0).filter(x => x > 0);
                    const runtimeList = skillData.map(item => item.runtime || 0).filter(x => x > 0);
                    const errorMadeList = skillData.map(item => item.error_made ? Math.max(0, 10 - item.error_made) : 0).filter(x => x > 0);

                    const avgCorrectness = correctnessList.length > 0 ? correctnessList.reduce((a,b) => a+b, 0) / correctnessList.length : 0;
                    const avgLineCode = lineCodeList.length > 0 ? lineCodeList.reduce((a,b) => a+b, 0) / lineCodeList.length : 0;
                    const avgTimeEfficiency = timeTakenList.length > 0 ? timeTakenList.reduce((a,b) => a+b, 0) / timeTakenList.length : 0;
                    const avgRuntime = runtimeList.length > 0 ? runtimeList.reduce((a,b) => a+b, 0) / runtimeList.length : 0;
                    const avgErrorHandling = errorMadeList.length > 0 ? errorMadeList.reduce((a,b) => a+b, 0) / errorMadeList.length : 0;

                    factorDataArr = [
                        Math.round(avgCorrectness * 10),
                        Math.round(avgLineCode * 10),
                        Math.round(avgTimeEfficiency * 10),
                        Math.round(avgRuntime * 10),
                        Math.round(avgErrorHandling * 10)
                    ];
                }

                // Skill Gap Chart (now based on 5 evaluation factors)
                const gapCtx = document.getElementById('skillGapChart').getContext('2d');
                new Chart(gapCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Correctness', 'Code Quality', 'Time Efficiency', 'Runtime Efficiency', 'Error Handling'],
                        datasets: [{
                            label: 'Average Proficiency',
                            data: factorDataArr,
                            borderColor: 'rgb(168, 85, 247)',
                            backgroundColor: 'rgba(168, 85, 247, 0.2)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(75, 85, 99, 0.2)' },
                                ticks: { color: '#9ca3af', backdropColor: 'transparent' },
                                pointLabels: { color: '#9ca3af' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
            }
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = '/jsat/app/auth/login.html';
        });
    </script>
</body>
</html>
