<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Runner - JSAT</title>
    <link href="/dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .timer-warning { animation: pulse 1s ease-in-out infinite; }
        .code-editor {
            font-family: 'Courier New', monospace;
            tab-size: 4;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/30">
                        <i data-lucide="satellite" class="w-7 h-7 text-white"></i>
                    </div>
                    <span class="text-2xl font-bold text-white">J-SAT</span>
                </div>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-red-400 rounded-lg transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto flex flex-col">

            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-4 sticky top-0 z-10">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="header-title" class="text-2xl font-bold text-white">Coding Area</h2>
                        <p id="progress" class="text-sm text-gray-400 mt-1">Loadingâ€¦</p>
                    </div>

                    <div class="flex items-center space-x-6">
                        <div class="bg-gray-800 px-6 py-3 rounded-lg border border-gray-700">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="clock" class="w-5 h-5 text-emerald-500"></i>
                                <div>
                                    <p class="text-xs text-gray-400">Time Remaining</p>
                                    <p id="timer" class="text-2xl font-bold text-white">00:00:00</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </header>

            <!-- Body -->
            <div class="p-8 flex-1">
                <div class=" rounded-xl p-6 shadow-md flex flex-col">

                    <!-- Question + Editor -->
                    <div class="lg:col-span-2 space-y-6">

                        <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                            <div id="question-panel"></div>
                        </div>

                        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-3 bg-gray-800 border-b border-gray-700">
                                <span class="text-sm font-medium text-white">Solution.java</span>
                            </div>

                            <textarea id="editor" class="code-editor w-full h-96 bg-gray-950 text-gray-100 p-6 font-mono text-sm resize-none focus:outline-none">
public class Main {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
    }
}
                            </textarea>
                        </div>

                        <!-- Input Section -->
                        <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-hidden">
                            <div class="flex items-center justify-between px-6 py-3 bg-gray-800 border-b border-gray-700">
                                <span class="text-sm font-medium text-white">Test Input</span>
                            </div>
                            <textarea id="input-area" class="w-full h-32 bg-gray-950 text-gray-100 p-6 font-mono text-sm resize-none focus:outline-none" placeholder="Enter test input for your program..."></textarea>
                        </div>

                                </div>
                            </div>
                            <pre id="console-text" class="p-6 text-sm text-gray-300"></pre>

                            <!-- Execution Stats -->
                            <div class="px-6 py-3 border-t border-gray-700 bg-gray-800">
                                <div class="grid grid-cols-3 gap-4 text-xs text-center">
                                    <div>
                                        <div class="text-gray-400">Status</div>
                                        <div id="exec-status" class="text-green-400 font-semibold">Ready</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400">Time</div>
                                        <div id="exec-time" class="text-blue-400 font-semibold">0s</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-400">Memory</div>
                                        <div id="exec-memory" class="text-yellow-400 font-semibold">0 KB</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons -->
                     
                        <div class="grid grid-cols-2 gap-4">
                            <button id="runBtn" class="bg-blue-500 hover:bg-blue-600 text-white py-4 rounded-lg transition">
                                Run Code
                            </button>

                            <button id="submitBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-4 rounded-lg transition flex items-center justify-center space-x-2">
                                <i data-lucide="send" class="w-5 h-5"></i>
                                <span>Submit Answer</span>
                            </button>
                        </div>


                        
                    </div>

                </div>
            </div>

        </main>
    </div>
    <script type="module">
        // Logout button logic for candidate panel
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    // Try to sign out from Supabase if available
                    if (window.supabase && window.supabase.auth && window.supabase.auth.signOut) {
                        try { await window.supabase.auth.signOut(); } catch (e) {}
                    }
                    window.location.href = '/auth/login.html';
                });
            }
        });
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../config.js";

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase configuration not found');
            document.body.innerHTML = `
                <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                    <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                        <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77-.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-2">Configuration Error</h1>
                        <p class="text-gray-300 mb-4 leading-relaxed">Supabase credentials not found.</p>
                    </div>
                </div>`;
        } else {
            // Wait for supabase to be available before proceeding
            function waitForSupabase() {
                return new Promise((resolve) => {
                    function checkSupabase() {
                        if (window.supabase && window.supabase.createClient) {
                            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                            resolve(supabase);
                        } else {
                            setTimeout(checkSupabase, 10);
                        }
                    }
                    checkSupabase();
                });
            }

            const supabase = await waitForSupabase();

        // Create global namespace (from evaluation.js)
        window.Evaluation = {

            async getCurrentUserProfileId() {
                const { data: { user } } = await supabase.auth.getUser();
                return user ? user.id : null;
            },

            evaluateCorrectness(code, expectedValues) {
                if (!code || !expectedValues) return 0;

                const normalizedCode = code.replace(/\s+/g, '').toLowerCase();
                const expectedChars = expectedValues.replace(/\s+/g, '').toLowerCase().split('');

                // Check if expected characters appear in order in the code
                let matchIndex = 0;
                for (const char of normalizedCode) {
                    if (matchIndex < expectedChars.length && char === expectedChars[matchIndex]) {
                        matchIndex++;
                    }
                }

                return matchIndex === expectedChars.length ? 10 : 0;
            },

            evaluateLevel(level, judgeResult, userCode, timeTaken, totalErrors, totalRuns, expectedAnswer) {

                const correctness = this.evaluateCorrectness(
                    userCode,
                    expectedAnswer
                );

                const lineCount = userCode.split("\n").length;
                const runtime = judgeResult.time || 0;

                let score = 0;
                let maxScore = level;

                switch (level) {
                    case 1: // Beginner - only correctness
                        score += correctness;
                        break;

                    case 2:
                        score += correctness;
                        if (timeTaken < 30) score++;
                        break;

                    case 3:
                        score += correctness;
                        if (timeTaken < 30) score++;
                        if (lineCount <= 20) score++;
                        break;

                    case 4:
                        score += correctness;
                        if (timeTaken < 30) score++;
                        if (lineCount <= 20) score++;
                        if (runtime < 0.10) score++;
                        break;

                    case 5:
                        score += correctness;
                        if (timeTaken < 30) score++;
                        if (lineCount <= 20) score++;
                        if (runtime < 0.10) score++;
                        if (totalErrors === 0 && totalRuns === 1) score++;
                        break;

                    default:
                        console.warn("Invalid level:", level);
                }

                return {
                    level,
                    score,
                    maxScore,
                    percentage: (score / maxScore) * 100,

                    details: {
                        correctness,
                        timeTaken,
                        lineCount,
                        runtime,
                        totalErrors,
                        totalRuns
                    }
                };
            }
        };

        // From test-runner.js
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();

            // DOM elements
            const runBtn = document.getElementById("runBtn");
            const editor = document.getElementById("editor");
            const inputArea = document.getElementById("input-area");
            const consoleEl = document.getElementById("console-text");
            const execStatus = document.getElementById("exec-status");
            const execTime = document.getElementById("exec-time");
            const execMemory = document.getElementById("exec-memory");
            const timerEl = document.getElementById("timer");
            const questionPanel = document.getElementById("question-panel");
            const submitBtn = document.getElementById("submitBtn");
            const headerTitle = document.getElementById("header-title");
            const progress = document.getElementById("progress");
            const clearConsoleBtn = document.getElementById("clearConsole");

            let instance = {
                id: null,
                durationMinutes: 30,
                questions: [],
                currentquestionIndex: 0,
                isTimed: false,
                startTime: null,
                timerInterval: null,
                timeRemaining: 0, // in seconds
                lastJudge0Result: null,
                totalRuns: 0,
                errorCount: 0
            };

            // Load question from URL param
            const loadQuestionFromParam = async () => {
                const urlParams = new URLSearchParams(window.location.search);
                const testParam = urlParams.get('test');

                if (!testParam) {
                    // No param, use mock for fallback
                    console.log('No test param, using mock data');
                    instance.questions = [
                        {
                            id: 1,
                            title: "Default Question",
                            question: "This is a default question. Please go back to dashboard and select a test."
                        }
                    ];
                    instance.isTimed = false;
                    instance.durationMinutes = 0;
                    return true;
                }

                console.log('Loading test with param:', testParam);

                // Handle both formats: question-ID, numeric ID, and human-readable names
                let questionId = null;

                if (testParam.startsWith('question-')) {
                    questionId = testParam.replace('question-', '');
                    console.log('Using question ID format:', questionId);
                } else if (!isNaN(testParam)) {
                    // Handle numeric question IDs directly (from dashboard)
                    questionId = parseInt(testParam);
                    console.log('Using numeric question ID:', questionId);
                } else {
                    // Try to map human-readable names to question IDs
                    const testNameToId = {
                        'java-fundamentals': 101,
                        'data-structures': 102,
                        'algorithms': 103
                        // Add more mappings as needed
                    };

                    questionId = testNameToId[testParam];
                    console.log('Mapped test name', testParam, 'to question ID:', questionId);
                }

                if (!questionId) {
                    console.log('Could not map test param to question ID:', testParam);
                    alert('Unknown test type: ' + testParam);
                    return false;
                }

                console.log('Final questionId to load:', questionId);

                try {
                    // Get current user and their level first
                    const { data: user } = await supabase.auth.getUser();
                    if (!user || !user.user) {
                        console.error('Not authenticated:', user);
                        throw new Error('Not authenticated');
                    }

                    console.log('Authenticated user:', user.user.id);

                    const { data: levelData, error: levelError } = await supabase
                        .from('level')
                        .select('level_status')
                        .eq('profile_id', user.user.id)
                        .single();

                    if (levelError) {
                        console.error('Error fetching user level:', levelError);
                        // Default to Beginner if level not found
                        console.log('Defaulting to Beginner level due to error');
                    }

                    const userLevel = levelData?.level_status || 'Beginner';
                    const levelMapping = { 'Beginner': 1, 'Novice': 2, 'Intermediate': 3, 'Advanced': 4, 'Expert': 5 };
                    const numericLevel = levelMapping[userLevel] || 1;

                    // Enable timing for Intermediate and above users
                    const isTimed = numericLevel >= 3; // Intermediate and above

                    console.log('Fetching question data for ID:', questionId);

                    const { data: question, error } = await supabase
                        .from('question')
                        .select('question_id, title, question, input, output, answer, difficulty, category')
                        .eq('question_id', questionId)
                        .single();

                    if (error || !question) {
                        console.error('Error fetching question:', error, 'Question:', question);
                        alert('Question not found.');
                        return false;
                    }

                    console.log('Question data fetched successfully:', question);

                    // Update instance
                    instance.id = questionId;
                    instance.questions = [question];
                    instance.isTimed = isTimed;
                    instance.durationMinutes = isTimed ? 30 : 0; // Set duration for timed tests
                    instance.userLevel = userLevel;

                    // Update UI
                    headerTitle.textContent = `Test: ${question.title}`;
                    progress.textContent = `${question.category} - ${question.difficulty} Level`;

                    console.log('Question loaded and UI updated successfully');
                    console.log('User level:', userLevel, 'Is timed:', isTimed);

                    // If not timed, hide timer or show unlimited
                    if (!instance.isTimed) {
                        const timerElement = document.querySelector('.bg-gray-800.px-6.py-3.rounded-lg.border.border-gray-700');
                        if (timerElement) {
                            timerElement.style.display = 'none';
                        }
                    }

                    return true;
                } catch (err) {
                    console.error('Error loading question:', err);
                    alert('Failed to load question.');
                    return false;
                }
            };

            // Judge0 CE (FREE, unlimited)
            const JUDGE0_URL ='https://ce.judge0.com/submissions/?base64_encoded=true&wait=true';


            const JAVA_ID = 91;

            // Run code
            const runCode = async () => {
                const sourceCode = editor.value.trim();

                if (!sourceCode) {
                    consoleEl.textContent = "Please write some code before running.";
                    return;
                }

                if (execStatus) {
                    execStatus.textContent = "Running...";
                    execStatus.style.color = '#fbbf24'; // yellow
                }
                consoleEl.textContent = "Executing...";

                const testInput = inputArea ? inputArea.value.trim() : '';

                const payload = {
                    language_id: JAVA_ID,
                    source_code: btoa(sourceCode),
                };

                // Only add stdin if there's actual input
                if (testInput) {
                    payload.stdin = btoa(testInput);
                }

                try {
                    const response = await fetch(JUDGE0_URL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload),
                    });

                    const result = await response.json();

                    // Track execution data
                    instance.totalRuns++;
                    if (result.status?.id !== 3) { // Not successful
                        instance.errorCount++;
                    }

                    // Store successful result
                    if (result.status?.id === 3) {
                        instance.lastJudge0Result = result;
                    }

                    // Update execution stats
                    if (execStatus) {
                        execStatus.textContent = result.status?.description || 'Error';
                        execStatus.style.color = result.status?.id === 3 ? '#10b981' : '#ef4444';
                    }
                    if (execTime) execTime.textContent = `${result.time || 0}s`;
                    if (execMemory) execMemory.textContent = `${result.memory || 0} KB`;

                    // If judge0 returns error structure
                    if (!result || !result.status) {
                        consoleEl.textContent =
                            "API Error: " +
                            (result.error || result.message || "Unexpected Judge0 response.");
                        return;
                    }

                    // Build output safely
                    let output = '';

                    if (result.stdout) {
                        output += `${atob(result.stdout)}\n`;
                    }
                    if (result.stderr) {
                        output += `Error: ${atob(result.stderr)}\n`;
                    }
                    if (result.compile_output) {
                        output += `Compilation: ${atob(result.compile_output)}\n`;
                    }

                    consoleEl.textContent = output || 'No output generated';

                } catch (err) {
                    console.error(err);
                    if (execStatus) {
                        execStatus.textContent = 'Error';
                        execStatus.style.color = '#ef4444';
                    }
                    consoleEl.textContent = "Network error. Please try again.";
                }
            };

            // Render questions
            const renderquestion = () => {
                const q = instance.questions[instance.currentquestionIndex];
                questionPanel.innerHTML = `
                    <h2 class="text-lg font-semibold">${q.title}</h2>
                    <div class="mt-2 text-sm text-gray-300">${q.question}</div>
                    ${q.input ? `<div class="mt-4 p-3 bg-gray-800 rounded border-l-4 border-blue-500">
                        <h3 class="text-sm font-semibold text-blue-400 mb-1">Sample Input:</h3>
                        <pre class="font-mono text-sm text-gray-200">${q.input}</pre>
                    </div>` : ''}
                    ${q.output ? `<div class="mt-3 p-3 bg-gray-800 rounded border-l-4 border-green-500">
                        <h3 class="text-sm font-semibold text-green-400 mb-1">Expected Output:</h3>
                        <pre class="font-mono text-sm text-gray-200">${q.output}</pre>
                    </div>` : ''}
                `;
            };

            // Timer functions
            const startTimer = () => {
                if (!instance.isTimed) return;

                instance.timeRemaining = instance.durationMinutes * 60; // Convert to seconds
                updateTimerDisplay();

                instance.timerInterval = setInterval(() => {
                    instance.timeRemaining--;

                    if (instance.timeRemaining <= 0) {
                        // Time's up - auto-submit the test
                        clearInterval(instance.timerInterval);
                        timerEl.textContent = "00:00:00";
                        timerEl.style.color = "#ef4444"; // Red color for expired timer

                        // Show time up warning and auto-submit
                        alert("Time's up! Your test will be automatically submitted.");
                        showSubmitModal();
                        return;
                    }

                    // Warning when 5 minutes remaining
                    if (instance.timeRemaining === 300) { // 5 minutes = 300 seconds
                        const timerContainer = document.querySelector('.bg-gray-800.px-6.py-3.rounded-lg.border.border-gray-700');
                        if (timerContainer) {
                            timerContainer.classList.add('timer-warning');
                            // Optional: Add visual warning
                        }
                    }

                    updateTimerDisplay();
                }, 1000);
            };

            const updateTimerDisplay = () => {
                if (!timerEl) return;

                const minutes = Math.floor(instance.timeRemaining / 60);
                const seconds = instance.timeRemaining % 60;

                const mm = String(minutes).padStart(2, "0");
                const ss = String(seconds).padStart(2, "0");

                timerEl.textContent = `${mm}:${ss}:00`;

                // Change color based on time remaining
                if (instance.timeRemaining <= 300) { // 5 minutes or less
                    timerEl.style.color = "#f59e0b"; // Orange for warning
                } else if (instance.timeRemaining <= 600) { // 10 minutes or less
                    timerEl.style.color = "#eab308"; // Yellow for caution
                } else {
                    timerEl.style.color = "#10b981"; // Green for normal
                }
            };

            const stopTimer = () => {
                if (instance.timerInterval) {
                    clearInterval(instance.timerInterval);
                    instance.timerInterval = null;
                }
            };

            // Display initial timer (static for non-timed tests)
            const displayTimer = (minutes) => {
                if (timerEl) {
                    const mm = String(minutes).padStart(2, "0");
                    timerEl.textContent = `${mm}:00:00`;
                }
            };

            // Submit test results to Supabase
            const submitTestResults = async () => {
                console.log('Submitting test results...');
                console.log('instance.lastJudge0Result:', instance.lastJudge0Result);
                console.log('instance.id:', instance.id);

                // If no previous run result, try to run the code first
                if (!instance.lastJudge0Result && instance.id) {
                    console.log('No previous run found, executing code before submission...');
                    try {
                        await runCode();
                    } catch (error) {
                        console.error('Failed to run code before submission:', error);
                        // Continue anyway - some evaluation metrics might still work
                    }
                }

                if (!instance.lastJudge0Result || !instance.id) {
                    console.error('No test results to submit');
                    return;
                }

                try {
                    console.log('Getting user from Supabase...');
                    const { data: user } = await supabase.auth.getUser();
                    console.log('User data:', user);

                    if (!user.user) {
                        console.error('Not authenticated - user.user is falsy');
                        throw new Error('Not authenticated');
                    }

                    console.log('Authenticated user ID:', user.user.id);

                    // Get user's current level
                    console.log('Fetching user level...');
                    const { data: levelData, error: levelError } = await supabase
                        .from('level')
                        .select('level_status')
                        .eq('profile_id', user.user.id)
                        .single();

                    if (levelError) {
                        console.error('Error fetching user level:', levelError);
                        throw new Error('Could not determine user level');
                    }

                    console.log('Level data:', levelData);
                    const userLevel = levelData?.level_status || 'Beginner';
                    const levelMapping = { 'Beginner': 1, 'Novice': 2, 'Intermediate': 3, 'Advanced': 4, 'Expert': 5 };
                    const numericLevel = levelMapping[userLevel] || 1;

                    console.log('User level:', userLevel, 'Numeric level:', numericLevel);

                    const question = instance.questions[0];
                    const sourceCode = editor.value;
                    const timeTaken = (Date.now() - instance.startTime) / (1000 * 60); // minutes

                    console.log('Question:', question);
                    console.log('Source code length:', sourceCode.length);
                    console.log('Time taken:', timeTaken);

                    // Calculate evaluation metrics based on user level
                    const correctness = Evaluation.evaluateCorrectness(
                        sourceCode,
                        question.answer || ''
                    );

                    console.log('Correctness score:', correctness);

                    const insertData = {
                        question_id: instance.id,
                        profile_id: user.user.id,
                        correctness: parseFloat(correctness.toFixed(1)),
                    };

                    console.log('Base insert data:', insertData);

                    // Add metrics progressively based on level
                    // Beginner: correctness
                    // Novice: + line_code
                    // Intermediate: + time_taken
                    // Advanced: + runtime
                    // Expert: + error_made

                    if (numericLevel >= 2) {
                        // Code quality evaluation
                        const linesOfCode = sourceCode.split('\n').filter(line => line.trim().length > 0).length;
                        const lineCode = Math.max(1, Math.min(10, 11 - linesOfCode)); // Shorter better, cap at 10
                        insertData.line_code = parseFloat(lineCode.toFixed(1));
                        console.log('Added line_code:', insertData.line_code);
                    }

                    if (numericLevel >= 3) {
                        insertData.time_taken = parseFloat(timeTaken.toFixed(1));
                        console.log('Added time_taken:', insertData.time_taken);
                    }

                    if (numericLevel >= 4) {
                        // Runtime evaluation
                        const runtime = instance.lastJudge0Result?.time || 0;
                        insertData.runtime = parseFloat(runtime.toFixed(1));
                        console.log('Added runtime:', insertData.runtime);
                    }

                    if (numericLevel >= 5) {
                        // Error handling evaluation
                        const errorRate = instance.totalRuns > 0 ? instance.errorCount / instance.totalRuns : 0;
                        const errorMade = Math.max(0, 10 - (errorRate * 10));
                        insertData.error_made = parseFloat(errorMade.toFixed(1));
                        console.log('Added error_made:', insertData.error_made);
                    }

                    console.log('Final insert data:', insertData);

                    console.log('Inserting into Supabase...');
                    const result = await supabase
                        .from('evaluation')
                        .insert(insertData)
                        .select('id')
                        .single();

                    console.log('Insert result:', result);

                    if (result.error) {
                        console.error('Insert error:', result.error);
                        throw result.error;
                    }

                    const evaluationId = result.data?.id;
                    console.log('Evaluation ID:', evaluationId);

                    // Store question title for quick access on completion page
                    localStorage.setItem('lastTestQuestionTitle', question.title);
                    localStorage.setItem('lastTestQuestionId', instance.id);

                    console.log('Test results saved successfully');
                    return evaluationId;
                } catch (error) {
                    console.error('Failed to save test results:', error);
                    alert('Failed to submit test results. Please try again.');
                }
            };

            // Submit modal
            const showSubmitModal = async () => {
                if (document.getElementById("submit-modal")) return;

                // Get user profile ID first
                const { data: user } = await supabase.auth.getUser();
                const profileId = user?.user?.id || 'Not available';

                // Get user's current level
                const { data: levelData, error: levelError } = await supabase
                    .from('level')
                    .select('level_status')
                    .eq('profile_id', profileId)
                    .single();

                const userLevel = levelData?.level_status || 'Beginner';
                const levelMapping = { 'Beginner': 1, 'Novice': 2, 'Intermediate': 3, 'Advanced': 4, 'Expert': 5 };
                const numericLevel = levelMapping[userLevel] || 1;

                // Calculate scores based on level
                const question = instance.questions[0];
                const sourceCode = editor.value;
                const timeTaken = (Date.now() - instance.startTime) / (1000 * 60);

                // Run level-based evaluation
                const evaluationResult = Evaluation.evaluateLevel(
                    numericLevel,
                    instance.lastJudge0Result || {},
                    sourceCode,
                    timeTaken,
                    instance.errorCount,
                    instance.totalRuns,
                    question.answer || ''
                );

                const questionId = instance.id || 'Not available';

                const modal = document.createElement("div");
                modal.id = "submit-modal";
                modal.className =
                    "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";

                modal.innerHTML = `
                    <div class="bg-gray-900 text-gray-100 p-6 rounded-lg w-[90%] max-w-lg text-center">
                        <h3 class="text-lg font-semibold mb-4">Test Results</h3>
                        <div class="space-y-3 text-left mb-4">
                            <div class="flex justify-between">
                                <span class="text-gray-400">User Profile ID:</span>
                                <span class="text-white font-mono text-sm">${profileId}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Question ID:</span>
                                <span class="text-white font-mono text-sm">${questionId}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Current Level:</span>
                                <span class="text-blue-400 font-bold">${userLevel}</span>
                            </div>
                        </div>
                        <div class="border-t border-gray-700 pt-4">
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Evaluation Factors:</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Correctness:</span>
                                    <span class="text-emerald-400">${evaluationResult.details.correctness}/10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Time Efficiency:</span>
                                    <span class="text-yellow-400">${Math.max(0, 10 - evaluationResult.details.timeTaken)}/10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Code Quality:</span>
                                    <span class="text-blue-400">${evaluationResult.details.lineCount > 20 ? 0 : Math.max(1, 11 - evaluationResult.details.lineCount)}/10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Runtime Performance:</span>
                                    <span class="text-orange-400">${evaluationResult.details.runtime >= 0 ? Math.max(0, 10 - evaluationResult.details.runtime * 10) : 10}/10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Error Handling:</span>
                                    <span class="text-red-400">${10 - (evaluationResult.details.totalRuns > 0 ? (evaluationResult.details.totalErrors / evaluationResult.details.totalRuns) * 10 : 0)}/10</span>
                                </div>
                                <div class="border-t border-gray-600 pt-2 mt-3">
                                    <div class="flex justify-between font-bold">
                                        <span class="text-gray-300">Total Score:</span>
                                        <span class="text-emerald-400">${Math.round((evaluationResult.score / evaluationResult.maxScore) * 100)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex items-center justify-center gap-3">
                            <button id="confirmSubmit" class="px-4 py-2 bg-emerald-500 rounded-md text-white font-semibold">Proceed to Results</button>
                            <button id="cancelSubmit" class="px-4 py-2 bg-gray-700 rounded-md text-gray-200">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById("confirmSubmit").onclick = async () => {
                    // Stop the timer first
                    stopTimer();
                    // Submit test results to Supabase first
                    const evaluationId = await submitTestResults();
                    modal.remove();
                    window.location.href = evaluationId ? `completion.html?evaluation_id=${evaluationId}` : "completion.html";
                };

                document.getElementById("cancelSubmit").onclick = () => modal.remove();
            };

            // Clear console functionality
            const clearConsole = () => {
                if (consoleEl) consoleEl.textContent = "Console cleared. Ready for new execution.";
            };

            // Events
            if (runBtn) runBtn.addEventListener("click", runCode);
            if (submitBtn) submitBtn.addEventListener("click", showSubmitModal);
            if (clearConsoleBtn) clearConsoleBtn.addEventListener("click", clearConsole);

            // Init
            const init = async () => {
                console.log('Initializing test-runner...');
                try {
                    const loaded = await loadQuestionFromParam();
                    console.log('Question loaded:', loaded);
                    if (loaded) {
                        console.log('Rendering question...');
                        renderquestion();
                        console.log('Displaying timer...');
                        displayTimer(instance.durationMinutes);
                        instance.startTime = Date.now(); // Start tracking time
                        console.log('Starting timer...');
                        startTimer(); // Start the countdown timer for timed tests
                    } else {
                        console.log('No question loaded, using fallback');
                    }
                } catch (error) {
                    console.error('Error during initialization:', error);
                }
            };

            init();
            });
        }
    </script>
    <script>lucide.createIcons();</script>
</body>
</html>
