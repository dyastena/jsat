<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete - JSAT</title>
    <link href="../../dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes checkmark {
            0% { stroke-dashoffset: 100; }
            100% { stroke-dashoffset: 0; }
        }
        @keyframes scaleIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .check-animation {
            stroke-dasharray: 100;
            animation: checkmark 0.8s ease-out forwards;
        }
        .circle-animation {
            animation: scaleIn 0.5s ease-out;
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            animation: confetti 3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="code-2" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">J-SAT</h1>
                        <p class="text-xs text-gray-400">Skills Assessment</p>
                    </div>
                </div>
            </div>
            
           <nav class="flex-1 p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 bg-emerald-500/10 text-emerald-500 rounded-lg">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="practice.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="target" class="w-5 h-5"></i>
                    <span class="font-medium">Practice Ground</span>
                </a>
                <a href="results.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Results</span>
                </a>
                <a href="leaderboard.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="trophy" class="w-5 h-5"></i>
                    <span class="font-medium">Leaderboard</span>
                </a>
                <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-red-400 rounded-lg transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto flex items-center justify-center p-8">
            <div class="max-w-3xl w-full">
                <!-- Success Animation -->
                <div class="text-center mb-8">
                    <div class="inline-block circle-animation">
                        <svg width="120" height="120" viewBox="0 0 120 120" class="mx-auto">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#10b981" stroke-width="4"/>
                            <path class="check-animation" d="M 30 60 L 50 75 L 90 40" fill="none" stroke="#10b981" stroke-width="6" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <h1 class="text-5xl font-bold text-white mt-6 mb-3">Test Completed!</h1>
                    <p class="text-xl text-gray-400">Excellent work, Alex! Your responses have been submitted successfully.</p>
                </div>

                <!-- Test Summary Card -->
                <div class="bg-gray-900 rounded-2xl border border-gray-800 p-8 mb-6">
                    <div class="flex items-center justify-between mb-6 pb-6 border-b border-gray-800">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Java Fundamentals Assessment</h2>
                            <p class="text-gray-400">Completed on November 13, 2025</p>
                        </div>
                        <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center">
                            <i data-lucide="check-circle" class="w-10 h-10 text-emerald-500"></i>
                        </div>
                    </div>

                    <!-- Preliminary Results -->
                    <div class="bg-gradient-to-r from-emerald-500/10 to-blue-500/10 rounded-lg p-6 border border-emerald-500/30">
                        <div class="flex items-start space-x-4">
                            <div class="w-12 h-12 bg-emerald-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-white mb-2">Preliminary Score</h3>
                                <div class="flex items-center space-x-4 mb-3">
                                    <div class="text-4xl font-bold text-emerald-400">87%</div>
                                    <div>
                                        <p class="text-sm text-gray-300">17 out of 20 correct</p>
                                        <p class="text-xs text-gray-400">Final results pending recruiter review</p>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-300">Great job! Your performance shows strong fundamentals in Java programming.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Level Progress Update -->
                <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-2xl border border-purple-500/30 p-8 mb-6">
                    <div class="flex items-center space-x-4 mb-6">
                        <div class="w-16 h-16 bg-purple-500 rounded-full flex items-center justify-center">
                            <i data-lucide="award" class="w-8 h-8 text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white mb-1">Level Progress Updated!</h3>
                            <p class="text-gray-400">You're getting closer to the next level</p>
                        </div>
                    </div>

                    <div class="bg-gray-900/50 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-emerald-400 font-bold">INTERMEDIATE</span>
                            <span class="text-white font-bold">183 / 200 pts</span>
                        </div>
                        <div class="w-full h-4 bg-gray-800 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full transition-all duration-1000" style="width: 91.5%"></div>
                        </div>
                        <p class="text-sm text-gray-400">Only 17 points to reach Advanced level! ðŸš€</p>
                    </div>
                </div>

               

                <!-- Action Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  
                    <button onclick="window.location.href='results.html'" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 rounded-lg transition flex items-center justify-center space-x-2">
                        <i data-lucide="bar-chart" class="w-5 h-5"></i>
                        <span>View Results</span>
                    </button>
                    <button onclick="window.location.href='exam.html'" class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-4 rounded-lg transition flex items-center justify-center space-x-2">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>Go to Dashboard</span>
                    </button>
                </div>

                
            </div>
        </main>
    </div>

    <script type="module">
        import { protectPage } from '../js/guard.js';
        import { logout } from '../js/auth.js';

        // Protect this page, only 'candidate' role is authorized
        protectPage(['candidate']).then(({ user, profile }) => {
            if (user && profile) {
                // User is authorized, proceed with rendering the completion page
                lucide.createIcons();

                // Confetti effect
                function createConfetti() {
                    const colors = ['#10b981', '#3b82f6', '#a855f7', '#f59e0b', '#ec4899'];
                    for (let i = 0; i < 50; i++) {
                        setTimeout(() => {
                            const confetti = document.createElement('div');
                            confetti.className = 'confetti';
                            confetti.style.left = Math.random() * 100 + '%';
                            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            confetti.style.animationDelay = Math.random() * 0.5 + 's';
                            confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                            document.body.appendChild(confetti);

                            setTimeout(() => confetti.remove(), 3500);
                        }, i * 30);
                    }
                }

                // Trigger confetti on load
                window.addEventListener('load', createConfetti);
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = '/jsat/app/auth/login.html';
        });
    </script>
      <script>lucide.createIcons();</script>

<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load user's latest test results
    const loadCompletionData = async () => {
        try {
            // Get current user
            const { data: user, error: authError } = await supabase.auth.getUser();
            if (authError || !user.user) {
                console.error('Authentication error:', authError);
                return;
            }

            // Get the user's most recent evaluation with result data
            const { data: evaluationData, error: evalError } = await supabase
                .from('evaluation')
                .select(`
                    id,
                    correctness,
                    line_code,
                    time_taken,
                    runtime,
                    error_made,
                    created_at,
                    question (
                        title,
                        difficulty,
                        category
                    ),
                    result (
                        score,
                        cart_eval
                    )
                `)
                .eq('profile_id', user.user.id)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();

            if (evalError || !evaluationData) {
                console.error('Failed to load evaluation data:', evalError);
                return;
            }

            // Get user's current level
            const { data: levelData, error: levelError } = await supabase
                .from('level')
                .select('level_status, progress')
                .eq('profile_id', user.user.id)
                .single();

            if (levelError) {
                console.log('Level data not available:', levelError);
            }

            // Update test summary
            updateTestSummary(evaluationData, levelData);

            // Update preliminary score
            updatePreliminaryScore(evaluationData);

            // Update level progress
            updateLevelProgress(evaluationData, levelData);

        } catch (error) {
            console.error('Error loading completion data:', error);
            // Fallback to default values
            updateDefaultData();
        }
    };

    const updateTestSummary = (evaluationData, levelData) => {
        console.log('Updating test summary with data:', evaluationData);
        const testTitleEl = document.querySelector('h2.text-2xl.font-bold.text-white.mb-1');
        const testDetailsEl = document.querySelector('.text-gray-400');

        // First try localStorage (from submission), then database
        const questionTitle = localStorage.getItem('lastTestQuestionTitle') || (evaluationData.question ? evaluationData.question.title : 'Test Completed');

        if (testTitleEl) {
            testTitleEl.textContent = questionTitle;
            console.log('Updated title to:', testTitleEl.textContent);
        }

        if (testDetailsEl && evaluationData.created_at) {
            const completionDate = new Date(evaluationData.created_at).toLocaleDateString();
    
            console.log('Updated date to:', testDetailsEl.textContent);
        }

        // Clear localStorage after use
        localStorage.removeItem('lastTestQuestionTitle');
        localStorage.removeItem('lastTestQuestionId');
    };

    const updatePreliminaryScore = (evaluationData) => {
        console.log('Updating preliminary score with data:', evaluationData);
        // Find the preliminary results container first
        const prelimContainer = document.querySelector('.bg-gradient-to-r.from-emerald-500\\/10.to-blue-500\\/10');
        const prelimScoreEl = prelimContainer ? prelimContainer.querySelector('.text-4xl.font-bold.text-emerald-400') : null;
        const prelimDetailsEl = prelimContainer ? prelimContainer.querySelector('.text-sm.text-gray-300') : null;

        if (prelimScoreEl && evaluationData.result && evaluationData.result.score != null) {
            const percentage = Math.round((evaluationData.result.score / 10) * 100);
            prelimScoreEl.textContent = `${percentage}%`;
            console.log('Updated score to:', prelimScoreEl.textContent);
        }

        if (prelimDetailsEl && evaluationData) {
            const factors = [
                evaluationData.correctness >= 7 ? 1 : 0,
                evaluationData.line_code >= 7 ? 1 : 0,
                evaluationData.time_taken <= 5 ? 1 : 0,  // Less than 5 minutes is good
                evaluationData.runtime <= 1 ? 1 : 0,     // Less than 1 second execution
                evaluationData.error_made <= 3 ? 1 : 0   // Few errors
            ].filter(Boolean).length;

            prelimDetailsEl.textContent = `${factors} out of 5 factors correct`;
            console.log('Updated factors to:', prelimDetailsEl.textContent);
        }
    };

    const updateLevelProgress = (evaluationData, levelData) => {
        console.log('Updating level progress with data:', levelData);

        // Level configuration
        const levelConfig = {
            'Beginner': {
                title: 'Welcome to Coding!',
                color: 'from-green-500/10 to-emerald-500/10',
                border: 'border-green-500/30',
                iconBg: 'bg-green-500',
                progressMsg: 'Keep going, you\'re building the foundation! ðŸŒ±',
                nextLevelThreshold: 100
            },
            'Novice': {
                title: 'Building Momentum!',
                color: 'from-blue-500/10 to-cyan-500/10',
                border: 'border-blue-500/30',
                iconBg: 'bg-blue-500',
                progressMsg: 'You\'re learning fast! Keep it up! ðŸ’ª',
                nextLevelThreshold: 150
            },
            'Intermediate': {
                title: 'Level Progress Updated!',
                color: 'from-purple-500/10 to-pink-500/10',
                border: 'border-purple-500/30',
                iconBg: 'bg-purple-500',
                progressMsg: 'Only few points to reach Advanced level! ðŸš€',
                nextLevelThreshold: 200
            },
            'Advanced': {
                title: 'Advanced Skills Achieved!',
                color: 'from-orange-500/10 to-red-500/10',
                border: 'border-orange-500/30',
                iconBg: 'bg-orange-500',
                progressMsg: 'Push further to reach Expert level! ðŸ”¥',
                nextLevelThreshold: 300
            },
            'Expert': {
                title: 'Expert Level Reached!',
                color: 'from-red-500/10 to-pink-500/10',
                border: 'border-red-500/30',
                iconBg: 'bg-red-500',
                progressMsg: 'Congratulations! You\'re at the top! ðŸ‘‘',
                nextLevelThreshold: 500
            }
        };

        // Get current level config
        const currentLevel = levelData?.level_status || 'Beginner';
        const config = levelConfig[currentLevel] || levelConfig['Beginner'];
        const currentProgress = Math.round(levelData?.progress || 0);

        // Keep card styling consistent (purple theme)
        // Card container styling and icon background remain the same

        // Update card title and subtitle (level progress card only)
        const levelCardTitle = document.querySelector('.bg-gradient-to-br + .bg-gradient-to-br .text-2xl.font-bold.text-white.mb-1');

        if (levelCardTitle) levelCardTitle.textContent = config.title;
        

        // Update progress section
        const levelContainer = document.querySelector('.bg-gray-900\\/50.rounded-lg');
        const levelNameEl = levelContainer ? levelContainer.querySelector('span.text-emerald-400') : null;
        const levelScoreEl = levelContainer ? levelContainer.querySelector('span.text-white.font-bold') : null;
        const progressBar = levelContainer ? levelContainer.querySelector('.h-full') : null;
        const progressMsgEl = levelContainer ? levelContainer.querySelector('.text-sm.text-gray-400') : null;

        if (levelNameEl) {
            levelNameEl.textContent = currentLevel.toUpperCase();
        }

        if (levelScoreEl) {
            levelScoreEl.textContent = `${currentProgress} / ${config.nextLevelThreshold} pts`;
        }

        if (progressBar) {
            const widthPercent = Math.min(100, (currentProgress / config.nextLevelThreshold) * 100);
            progressBar.style.width = `${widthPercent}%`;
        }

        if (progressMsgEl) {
            // Calculate remaining points
            const remaining = Math.max(0, config.nextLevelThreshold - currentProgress);
            let message = config.progressMsg;

            if (remaining > 0 && currentLevel !== 'Beginner') {
                message = `Only ${remaining} points to reach ${getNextLevel(currentLevel)} level! ðŸš€`;
            }

            progressMsgEl.textContent = message;
        }

        console.log('Updated level card for:', currentLevel, 'with progress:', currentProgress);
    };

    const getNextLevel = (currentLevel) => {
        const levels = ['Beginner', 'Novice', 'Intermediate', 'Advanced', 'Expert'];
        const currentIndex = levels.indexOf(currentLevel);
        return currentIndex < levels.length - 1 ? levels[currentIndex + 1] : 'Master';
    };

    const updateDefaultData = () => {
        // Default fallback data
        const prelimScoreEl = document.querySelector('.bg-gradient-to-r.from-emerald-500\\/10.to-blue-500\\/10 .text-4xl');
        if (prelimScoreEl) {
            prelimScoreEl.textContent = '87%';
        }

        const prelimDetailsEl = document.querySelector('.bg-gradient-to-r.from-emerald-500\\/10.to-blue-500\\/10 .text-sm');
        if (prelimDetailsEl) {
            prelimDetailsEl.textContent = '4 out of 5 factors correct';
        }

        const levelScoreEl = document.querySelector('.bg-gray-900\\/50 span.text-white');
        if (levelScoreEl) {
            levelScoreEl.textContent = '183 / 200 pts';
        }
    };

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadCompletionData);
</script>

</body>
</html>
