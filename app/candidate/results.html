<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - JSAT</title>
    <link href="/dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
      
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 flex flex-col">
            <div class="p-6 border-b border-gray-800">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="code-2" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">J-SAT</h1>
                        <p class="text-xs text-gray-400">Skills Assessment</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span class="font-medium">Dashboard</span>
                </a>
                <a href="practice.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="target" class="w-5 h-5"></i>
                    <span class="font-medium">Practice Ground</span>
                </a>
                <a href="results.html" class="flex items-center space-x-3 px-4 py-3 bg-emerald-500/10 text-emerald-500 rounded-lg">
                    <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                    <span class="font-medium">Results</span>
                </a>
                <a href="leaderboard.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="trophy" class="w-5 h-5"></i>
                    <span class="font-medium">Leaderboard</span>
                </a>
                <a href="settings.html" class="flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-gray-800">
                <button id="logout-btn" class="w-full flex items-center space-x-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-red-400 rounded-lg transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-gray-900 border-b border-gray-800 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white">Test Results</h2>
                        <p class="text-gray-400 mt-1">Java Fundamentals Assessment</p>
                    </div>
                    <button class="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-lg transition flex items-center space-x-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        <span>Download Report</span>
                    </button>
                </div>
            </header>

            <div class="p-8 space-y-8">
                <!-- Score Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="md:col-span-1 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-8 text-white fade-in">
                        <div class="flex flex-col items-center text-center">
                            <i data-lucide="award" class="w-16 h-16 mb-4"></i>
                            <p class="text-sm opacity-90 mb-2">Overall Score</p>
                            <p class="text-6xl font-bold mb-2" id="overall-score"></p>
                            <p class="text-sm opacity-90" id="score-fraction"></p>
                        </div>
                    </div>

                    <div class="md:col-span-3 grid grid-cols-3 gap-6">
                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="target" class="w-6 h-6 text-blue-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">0%</span>
                            </div>
                            <p class="text-sm text-gray-400">Accuracy</p>
                            
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="code" class="w-6 h-6 text-purple-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">0%</span>
                            </div>
                            <p class="text-sm text-gray-400">Code Style</p>
                          
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-orange-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="clock" class="w-6 h-6 text-orange-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">0%</span>
                            </div>
                            <p class="text-sm text-gray-400">Time Taken</p>
                         
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="zap" class="w-6 h-6 text-green-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">0%</span>
                            </div>
                            <p class="text-sm text-gray-400">Code Efficiency</p>
                            
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">0%</span>
                            </div>
                            <p class="text-sm text-gray-400">Errors</p>
                            
                        </div>

                        <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 fade-in">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                    <i data-lucide="star" class="w-6 h-6 text-yellow-500"></i>
                                </div>
                                <span class="text-2xl font-bold text-white">+18</span>
                            </div>
                            <p class="text-sm text-gray-400">Points Earned</p>
                        
                        </div>
                    </div>
                </div>

                <!-- CART Evaluation & Level -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- CART Classification -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-xl font-bold text-white mb-4">CART Skill Classification</h3>
                        <div class="bg-gradient-to-br from-emerald-500/20 to-emerald-600/20 rounded-lg p-6 border border-emerald-500/30 mb-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="text-sm text-gray-400 mb-1">Your Classification</p>
                                    <p class="text-3xl font-bold text-emerald-400" id="classification-level">LOADING</p>
                                </div>
                                <div class="w-20 h-20 bg-emerald-500 rounded-full flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-10 h-10 text-white" id="classification-icon"></i>
                                </div>
                            </div>
                            <p class="text-sm text-gray-300" id="classification-description">Loading...</p>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Problem Solving</span>
                                    <span class="text-sm font-semibold text-white" id="problem-solving-score">0/10</span>
                                </div>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-500 rounded-full" id="problem-solving-bar"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Algorithm Design</span>
                                    <span class="text-sm font-semibold text-white" id="algorithm-design-score">0/10</span>
                                </div>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-emerald-500 rounded-full" id="algorithm-design-bar"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Code Quality</span>
                                    <span class="text-sm font-semibold text-white" id="code-quality-score">0/10</span>
                                </div>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 rounded-full" id="code-quality-bar"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Time Efficiency</span>
                                    <span class="text-sm font-semibold text-white" id="time-efficiency-score">0/10</span>
                                </div>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-500 rounded-full" id="time-efficiency-bar"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-gray-400">Error Handling</span>
                                    <span class="text-sm font-semibold text-white" id="error-handling-score">0/10</span>
                                </div>
                                <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                                    <div class="h-full bg-yellow-500 rounded-full" id="error-handling-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Radar Chart -->
                    <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                        <h3 class="text-xl font-bold text-white mb-4">Performance Analysis</h3>
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

               

                <!-- question Breakdown -->
                <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
                    <h3 class="text-xl font-bold text-white mb-6">question-by-question Breakdown</h3>
                    <div class="space-y-3 test-breakdown-container">
                        <!-- Test result cards will be dynamically created based on number of completed tests -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from "../config.js";

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
            console.error('Supabase configuration not found');
            document.body.innerHTML = `
                <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                    <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                        <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                            <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77-.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-bold text-red-400 mb-2">Configuration Error</h1>
                        <p class="text-gray-300 mb-4 leading-relaxed">Supabase credentials not found.</p>
                    </div>
                </div>`;
        } else {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        /**
         * Handles user logout.
         */
        async function logout() {
            await supabase.auth.signOut();
        }

        /**
         * Redirects to the appropriate dashboard based on user role.
         * @param {string} role - The user's role.
         */
        function redirectUser(role) {
            const rolePaths = {
                admin: '/jsat/app/admin/users.html',
                recruiter: '/jsat/app/recruiter/dashboard.html',
                candidate: '/jsat/app/candidate/dashboard.html',
            };
            // Use lowercase role from DB
            const redirectPath = rolePaths[role] || '/jsat/app/auth/login.html';
            window.location.href = redirectPath;
        }

        /**
         * Protects a page by checking the user's authentication status and role.
         * It redirects unauthorized users to the appropriate page.
         *
         * @param {string[]} authorizedRoles - An array of roles (e.g., ['admin', 'recruiter']) that are allowed to access the page. If empty, only checks for login.
         * @returns {Promise<{user: object, profile: object}|null>} The user and profile objects if authorized, otherwise null as a redirect is initiated.
         */
        async function protectPage(authorizedRoles = []) {
            // 1. Get the current user from Supabase's session
            const { data: { user } } = await supabase.auth.getUser();

            // If no user is logged in, redirect to the login page
            if (!user) {
                window.location.href = '/jsat/app/auth/login.html';
                return null;
            }

            // 2. Get the user's profile from the database
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('role, is_role_finalized')
                .eq('id', user.id)
                .single();

            // If there's an error or the profile doesn't exist, something is wrong.
            // Redirect to login for safety.
            if (error || !profile) {
                console.error('Error fetching profile or profile not found. Redirecting to login.');
                window.location.href = '/jsat/app/auth/login.html';
                return null;
            }

            // 3. Check if the user's role has been finalized
            // If not, they must be sent to the role selection page.
            if (!profile.is_role_finalized) {
                window.location.href = '/jsat/app/auth/role_selection.html';
                return null;
            }

            // 4. Check if the user's role is in the list of authorized roles for the page
            if (authorizedRoles.length > 0 && !authorizedRoles.includes(profile.role)) {
                // If the user's role is not authorized, show error and block access
                console.warn(`Unauthorized access attempt by role '${profile.role}'. Blocking access.`);

                // Replace the page content with an error message using Tailwind CSS
                document.body.innerHTML = `
                    <div class="fixed inset-0 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center font-sans z-50">
                        <div class="text-center text-white max-w-md mx-4 p-8 bg-gray-900/90 backdrop-blur-sm rounded-2xl border border-red-500/30 shadow-2xl">
                            <div class="w-16 h-16 bg-red-500/20 border-2 border-red-500/30 rounded-full flex items-center justify-center mx-auto mb-6">
                                <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <h1 class="text-2xl font-bold text-red-400 mb-2">Access Denied</h1>
                            <p class="text-gray-300 mb-4 leading-relaxed">
                                You don't have permission to access this page.
                            </p>
                            <div class="bg-gray-800/50 rounded-lg p-4 mb-6">
                                <div class="text-sm text-gray-400 mb-1">Your current role:</div>
                                <div class="text-lg font-semibold text-blue-400 capitalize">${profile.role}</div>
                                <div class="text-sm text-gray-400 mt-2 mb-1">Required role(s):</div>
                                <div class="text-lg font-semibold text-yellow-400">${authorizedRoles.join(', ')}</div>
                            </div>
                            <p class="text-gray-500 text-sm">
                                Redirecting you to your dashboard in <span id="countdown" class="text-blue-400 font-semibold">3</span> seconds...
                            </p>
                        </div>
                    </div>
                `;

                // Countdown timer
                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                const timer = setInterval(() => {
                    countdown--;
                    if (countdownEl) countdownEl.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(timer);
                        redirectUser(profile.role);
                    }
                }, 1000);

                return null;
            }

            // 5. If all checks pass, the user is authorized.
            // Return the user and profile data for the page to use.
            return { user, profile };
        }

        /**
         * Fetch average performance metrics across all users
         * @returns {Promise<Array>} [accuracy, efficiency, style, errorHandling, runtime]
         */
        async function getAveragePerformance() {
            try {
                // Fetch all evaluation data for candidate users
                const { data: evaluations, error } = await supabase
                    .from('evaluation')
                    .select('correctness, line_code, runtime, error_made, time_taken, profile_id');

                if (error) {
                    console.error('Error fetching average performance:', error);
                    return [75, 70, 72, 68, 75]; // Fallback to defaults
                }

                if (!evaluations || evaluations.length === 0) {
                    return [0, 0, 0, 0, 0]; // Return 0s if no evaluation data exists in system
                }

                // Calculate averages
                const totalEntries = evaluations.length;
                let totalCorrectness = 0, countCorrectness = 0;
                let totalLineCode = 0, countLineCode = 0;
                let totalRuntime = 0, countRuntime = 0;
                let totalErrors = 0, countErrors = 0;
                let totalTimeTaken = 0, countTime = 0;

                evaluations.forEach(evaluation => {
                    if (evaluation.correctness !== null) {
                        totalCorrectness += evaluation.correctness;
                        countCorrectness++;
                    }
                    if (evaluation.line_code !== null) {
                        totalLineCode += evaluation.line_code;
                        countLineCode++;
                    }
                    if (evaluation.runtime !== null) {
                        totalRuntime += evaluation.runtime;
                        countRuntime++;
                    }
                    if (evaluation.error_made !== null) {
                        totalErrors += evaluation.error_made;
                        countErrors++;
                    }
                    if (evaluation.time_taken !== null) {
                        totalTimeTaken += evaluation.time_taken;
                        countTime++;
                    }
                });

                // Calculate average percentages (assuming raw scores are 0-1 or 0-10)
                const avgAccuracy = countCorrectness > 0 ? (totalCorrectness / countCorrectness) * 10 : 0;
                const avgEfficiency = countRuntime > 0 ? (totalRuntime / countRuntime) * 10 : 0;
                const avgStyle = countLineCode > 0 ? (totalLineCode / countLineCode) * 10 : 0;
                const avgErrors = countErrors > 0 ? (totalErrors / countErrors) * 10 : 0; // Scale to 0-100 range
                const avgTime = countTime > 0 ? (totalTimeTaken / countTime) * 10 : 0;

                // Return in chart format: [Accuracy, Efficiency, Style, ErrorHandling (inverted), Runtime (inverted)]
                // For inverted metrics: if no data (avg=0), show 0; if data exists, invert (100 - value)
                return [
                    Math.min(100, Math.max(0, avgAccuracy)),
                    Math.min(100, Math.max(0, avgEfficiency)),
                    Math.min(100, Math.max(0, avgStyle)),
                    Math.min(100, Math.max(0, avgErrors === 0 ? 0 : 100 - avgErrors)), // Fewer errors = better; if no data, show 0
                    Math.min(100, Math.max(0, avgTime === 0 ? 0 : 100 - avgTime))     // Less time = better; if no data, show 0
                ];
            } catch (err) {
                console.error('Error getting average performance:', err);
                return [75, 70, 72, 68, 75];
            }
        }

        /**
         * Load and display results data
         * @param {string} userId - The user's ID
         * @returns {Object} The calculated results data
         */
        async function loadResults(userId) {
            try {
                console.log('Loading results for user:', userId);

                // Guard: check if userId is valid
                if (!userId || userId === 'undefined' || typeof userId !== 'string' || userId.length !== 36) {
                    console.warn('Invalid userId, loading default data');
                    // Fixed: time should be 3.8 not 38 (normalized scale where 30 minutes is be 3.0 in 10s scale)
                    const defaultAverages = [0, 8.5, 3.8, 7.8, 2, 18];
                    populateUI(0, defaultAverages, 17, 20, 26);
                    return { averages: defaultAverages };
                }

                // Fetch overall progress from level table
                const { data: levelData, error: levelError } = await supabase
                    .from('level')
                    .select('progress, level_status')
                    .eq('profile_id', userId)
                    .single();

                if (levelError && levelError.code !== 'PGRST116') { // Allow missing level data
                    console.error('Error fetching level data:', levelError);
                    alert('Error loading level data: ' + levelError.message);
                    return { averages: [0, 0, 0, 0, 0] };
                }

                console.log('Level data:', levelData);

                // Fetch user's evaluations with scores
                const { data: evaluationData, error: evalError } = await supabase
                    .from('evaluation')
                    .select('correctness, line_code, time_taken, runtime, error_made, id')
                    .eq('profile_id', userId);

                if (evalError) {
                    console.error('Error fetching evaluation data:', evalError);
                    alert('Error loading evaluation data: ' + evalError.message);
                    return { averages: [0, 0, 0, 0, 0] };
                }

                console.log('Evaluation data:', evaluationData);

                // If no evaluations, set defaults
                if (!evaluationData || evaluationData.length === 0) {
                    console.log('No evaluations found for user');
                    const defaultAverages = [0, 0, 0, 0, 0];
                    populateUI(0, [...defaultAverages, 0], 0, 0, 0);
                    return { averages: defaultAverages };
                }

                // Fetch recent result score
                const { data: recentResult, error: resultError } = await supabase
                    .from('result')
                    .select('score')
                    .eq('evaluation_id', evaluationData[evaluationData.length - 1].id)
                    .single();

                let recentScore = 0;
                if (resultError && resultError.code !== 'PGRST116') { // Allow missing result data
                    console.error('Error fetching recent result:', resultError);
                } else if (!resultError && recentResult) {
                    recentScore = recentResult.score;
                }

                console.log('Recent score:', recentScore);

                // Fetch all user's results with scores and cart_eval, joining with questions
                const { data: resultData, error: resultAllError } = await supabase
                    .from('result')
                    .select(`
                        score,
                        cart_eval,
                        evaluation_id,
                        evaluation!inner(question_id, question!inner(title, category, difficulty))
                    `)
                    .in('evaluation_id', evaluationData.map(e => e.id));

                if (resultAllError) {
                    console.error('Error fetching all result data:', resultAllError);
                    return { averages: [0, 0, 0, 0, 0] };
                }

                console.log('All result data with questions:', resultData);

                // Calculate totals from result data
                let max_per_test = 10; // max score per test
                let totalCorrect = resultData.reduce((sum, r) => sum + (r.score || 0), 0);
                let countTestsTaken = resultData.length;
                let countCorrectness = countTestsTaken * max_per_test;

                // Calculate averages and populate UI
                const calculation = calculateAverages(evaluationData);
                const overall = levelData ? levelData.progress : 0;
                const data = [...calculation.averages, recentScore];

                populateUI(overall, data, totalCorrect, countCorrectness, calculation.totalPoints);

                return {
                    averages: calculation.averages,
                    totalScore: totalCorrect,
                    testCount: countTestsTaken,
                    testResults: resultData || []  // Include detailed test results with titles, scores, cart_eval
                };

            } catch (err) {
                console.error('Error loading results:', err);
                alert('Failed to load results: ' + err.message);
                return { averages: [0, 0, 0, 0, 0] };
            }
        }

        /**
         * Calculate average metrics from evaluations
         * @param {Array} evaluations - Array of evaluation records
         * @returns {Object} {averages: [accuracy, efficiency, time, style, errors], totalCorrect, countCorrectness, totalPoints}
         */
        function calculateAverages(evaluations) {
            let totalCorrectness = 0, countCorrectness = 0;
            let totalCorrect = 0;
            let totalLineCode = 0, countLineCode = 0;
            let totalTime = 0, countTime = 0;
            let totalRuntime = 0, countRuntime = 0;
            let totalErrors = 0;
            let totalPoints = 0;

            evaluations.forEach(evaluation => {
                // Sum all non-null values for total points
                totalPoints += (evaluation.correctness || 0) + (evaluation.line_code || 0) + (evaluation.time_taken || 0) + (evaluation.runtime || 0) + (evaluation.error_made || 0);

                // Correctness: assume 0-1, used for count and percentage
                if (evaluation.correctness !== null && evaluation.correctness !== undefined) {
                    totalCorrectness += evaluation.correctness;
                    if (evaluation.correctness >= 0.8) { // assuming 80% is considered correct
                        totalCorrect += 1;
                    }
                    countCorrectness++;
                }

                // Line_code: assume score 0-10, scale to 0-10
                if (evaluation.line_code !== null && evaluation.line_code !== undefined) {
                    totalLineCode += parseFloat(evaluation.line_code);
                    countLineCode++;
                }

                // Time_taken: assume in minutes
                if (evaluation.time_taken !== null && evaluation.time_taken !== undefined) {
                    totalTime += parseFloat(evaluation.time_taken);
                    countTime++;
                }

                // Runtime: assume score 0-10
                if (evaluation.runtime !== null && evaluation.runtime !== undefined) {
                    totalRuntime += parseFloat(evaluation.runtime);
                    countRuntime++;
                }

                // error_made: count errors
                if (evaluation.error_made !== null && evaluation.error_made !== undefined) {
                    totalErrors += parseFloat(evaluation.error_made);
                }
            });

            const accuracy = countCorrectness > 0 ? (totalCorrectness / countCorrectness) * 10 : 0;
            const efficiency = countRuntime > 0 ? (totalRuntime / countRuntime) * 10 : 0;
            const avgTime = countTime > 0 ? (totalTime / countTime) * 10 : 0;
            const style = countLineCode > 0 ? (totalLineCode / countLineCode) * 10 : 0;
            const errors = countTime > 0 ? (totalErrors / countTime) * 10 : 0; // average errors per test * 10

            return {
                averages: [accuracy, efficiency, avgTime, style, errors],
                totalCorrect,
                countCorrectness,
                totalPoints
            };
        }

        /**
         * Populate the CART Skill Classification card showing overall performance and individual factors
         * @param {number} totalScore - Total score from all user's test results
         * @param {number} testCount - Number of tests taken by the user
         * @param {Array} averages - [accuracy, efficiency, avgTime, style, errors] all 0-10
         */
        function populateClassificationCard(totalScore, testCount, averages) {
            try {
                console.log('Populating classification card with totalScore:', totalScore, 'testCount:', testCount);

                // Validate input
                if (typeof totalScore !== 'number' || typeof testCount !== 'number') {
                    console.error('Invalid input - totalScore:', totalScore, 'testCount:', testCount);
                    totalScore = 0;
                    testCount = 1;
                }

                // Calculate average score per test (assuming each test is out of 10)
                const avgScorePerTest = testCount > 0 ? totalScore / testCount : 0;
                const avgScoreScaled = Math.min(10, Math.max(0, avgScorePerTest)); // Cap at 0-10 scale

                console.log('Calculated scores:', { totalScore, testCount, avgScorePerTest, avgScoreScaled });

                // Determine classification level based on average score (0-10 scale)
                let level = 'RANK D';
                let description = 'Fundamental coding abilities with basic comprehension';
                let icon = 'trending-up';

                if (avgScoreScaled <= 2) {
                    level = 'RANK D';
                    description = 'Fundamental coding abilities with basic comprehension';
                    icon = 'trending-up';
                } else if (avgScoreScaled <= 4) {
                    level = 'RANK C';
                    description = 'Growing competency with emerging problem-solving skills';
                    icon = 'zap';
                } else if (avgScoreScaled <= 6) {
                    level = 'RANK B';
                    description = 'Established problem-solving with reliable code execution';
                    icon = 'target';
                } else if (avgScoreScaled <= 8) {
                    level = 'RANK A';
                    description = 'Advanced efficiency and code quality across multiple domains';
                    icon = 'star';
                } else {
                    level = 'RANK S';
                    description = 'Elite mastery with exceptional coding skills';
                    icon = 'award';
                }

                console.log('Classification determined:', { level, description, icon, avgScoreScaled });

                // Update elements
                const levelEl = document.getElementById('classification-level');
                if (levelEl) {
                    levelEl.textContent = level;
                }

                const iconEl = document.getElementById('classification-icon');
                if (iconEl) {
                    iconEl.setAttribute('data-lucide', icon);
                }

                const descEl = document.getElementById('classification-description');
                if (descEl) {
                    descEl.textContent = description;
                }

                // Calculate scores for each skill (using the averages passed in)
                const [accuracy, efficiency, avgTime, style, errors] = averages || [0, 0, 0, 0, 0];

                const problemSolving = Math.max(0, Math.min(10, accuracy || 0));
                const algorithmDesign = Math.max(0, Math.min(10, efficiency || 0));
                const codeQuality = Math.max(0, Math.min(10, style || 0));
                const timeEfficiency = Math.max(0, Math.min(10, avgTime === 0 ? 0 : Math.max(0, 10 - avgTime)));
                const errorHandling = errors === 0 ? 0 : Math.max(0, Math.min(10, 10 - errors));

                // Update the individual skill factors - show all for all levels
                const metrics = [
                    { id: 'problem-solving', score: problemSolving },
                    { id: 'algorithm-design', score: algorithmDesign },
                    { id: 'code-quality', score: codeQuality },
                    { id: 'time-efficiency', score: timeEfficiency },
                    { id: 'error-handling', score: errorHandling }
                ];

                // Map classification factors to correspond with the small card display order
                // Small cards show: [0]Accuracy, [3]Code Style, [2]Time Taken, [1]Code Efficiency, [4]Errors
                const factorMappings = [
                    { id: 'problem-solving', averageIndex: 0 },  // maps to Accuracy %
                    { id: 'algorithm-design', averageIndex: 3 },  // maps to Code Style %
                    { id: 'code-quality', averageIndex: 2 },     // maps to Time Taken %
                    { id: 'time-efficiency', averageIndex: 1 },  // maps to Code Efficiency %
                    { id: 'error-handling', averageIndex: 4 }    // maps to Errors %
                ];

                console.log('Populating factor scores:', factorMappings);

                factorMappings.forEach(mapping => {
                    const scoreEl = document.getElementById(`${mapping.id}-score`);
                    const barEl = document.getElementById(`${mapping.id}-bar`);
                    const percentageValue = averages[mapping.averageIndex] || 0;
                    const decimalValue = percentageValue / 10;
                    const displayValue = decimalValue % 1 === 0 ? decimalValue.toFixed(0) : decimalValue.toFixed(1);

                    console.log(`Setting ${mapping.id}-score to: ${displayValue}/10`);
                    console.log(`Setting ${mapping.id}-bar width to: ${percentageValue}%`);

                    // Display as X/10 or X.X/10 format (decimal only if needed)
                    if (scoreEl) scoreEl.textContent = `${displayValue}/10`;
                    if (barEl) barEl.style.width = `${percentageValue}%`;  // Keep percentage for bar width
                });

                // Recreate lucide icons
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }

                console.log('Classification card populated successfully with overall score and individual factors');
            } catch (error) {
                console.error('Error populating classification card:', error);
            }
        }

        /**
         * Populate the question-by-question breakdown cards with real test data
         * @param {Array} testResults - Array of test results with question titles, scores, and cart_eval
         */
        function populateTestBreakdown(testResults) {
            try {
                console.log('Populating question-by-question cards with', testResults?.length || 0, 'results');

                const container = document.querySelector('.test-breakdown-container');

                if (!container) {
                    console.warn('Test breakdown container not found');
                    return;
                }

                // Clear existing content
                container.innerHTML = '';

                if (!testResults || testResults.length === 0) {
                    // Show no tests message
                    const noTestsCard = document.createElement('div');
                    noTestsCard.className = 'bg-gray-800/50 rounded-lg p-4 border border-gray-700';
                    noTestsCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="w-10 h-10 bg-gray-500 rounded-lg flex items-center justify-center">
                                <i data-lucide="help-circle" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-white font-semibold">No tests completed yet</h4>
                                <p class="text-sm text-gray-400">Complete tests to see detailed results here</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(noTestsCard);
                    return;
                }

                // Create a card for each test result
                testResults.forEach((result, index) => {
                    const questionTitle = result.evaluation?.question?.title || 'Unknown Question';
                    const score = result.score || 0;
                    const cartEval = result.cart_eval || 'UNKNOWN';
                    const category = result.evaluation?.question?.category || 'Unknown';
                    const difficulty = result.evaluation?.question?.difficulty || 'Unknown';

                    // Determine icon and color based on score
                    let iconName = 'minus';
                    let iconColor = 'yellow';
                    let scoreText = '';
                    let scoreColor = 'yellow';

                    if (score >= 8) {
                        iconName = 'check';
                        iconColor = 'green';
                        scoreText = 'Excellent';
                        scoreColor = 'green';
                    } else if (score >= 6) {
                        iconName = 'check';
                        iconColor = 'green';
                        scoreText = 'Good';
                        scoreColor = 'green';
                    } else {
                        iconName = 'minus';
                        iconColor = 'yellow';
                        scoreText = 'Partial credit';
                    }

                    const testCard = document.createElement('div');
                    testCard.className = 'bg-gray-800/50 rounded-lg p-4 border border-gray-700';

                    testCard.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4 flex-1">
                                <div class="w-10 h-10 bg-${iconColor}-500 rounded-lg flex items-center justify-center">
                                    <i data-lucide="${iconName}" class="w-5 h-5 text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="text-white font-semibold">${index + 1}: ${questionTitle}</h4>
                                    <p class="text-sm text-gray-400">${category} | ${difficulty} Level</p>
                                </div>
                            </div>
                            <div class="text-right mr-2">
                                <p class="text-emerald-500 font-bold text-lg">${score}/10</p>
                                <p class="text-sm text-gray-400">${cartEval}</p>
                            </div>
                            <button class="px-2 py-1 bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium rounded transition duration-200" onclick="console.log('Result button clicked for evaluation_id:', ${result.evaluation_id}); window.location.href='completion.html?evaluation_id=${result.evaluation_id}'">
                                Result
                            </button>
                        </div>
                    `;

                    container.appendChild(testCard);
                });

                // Recreate lucide icons after adding new content
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                }

                console.log('Question-by-question cards populated successfully');
            } catch (error) {
                console.error('Error populating question-by-question cards:', error);
            }
        }

        /**
         * Populate the UI with results data
         * @param {number} overall - Overall progress points
         * @param {Array} averages - [accuracy %, efficiency /10, time m, style /10, errors, recent score]
         * @param {number} totalCorrect - Total sum of scores
         * @param {number} countCorrectness - Total number of tests * max_per_test
         * @param {number} totalPoints - Total points earned
         */
        function populateUI(overall, averages, totalCorrect, countCorrectness, totalPoints) {
            let countTestsTaken = countCorrectness / 10; // Assuming max_per_test = 10
            let avgScore = countTestsTaken > 0 ? totalCorrect / countTestsTaken : 0;
            let overallPercent;
            if (totalCorrect === 17 && countCorrectness === 20) {
                // Default data: average score 8.5, so 85%
                overallPercent = 85.0;
            } else {
                overallPercent = avgScore * 10; // Convert average score (out of 10) to percentage
            }

            // Overall score: percentage based on average of test scores
            const overallElement = document.getElementById('overall-score');
            if (overallElement) {
                overallElement.textContent = `${overallPercent}%`;
            }

            // Score fraction: shows number of tests taken
            const fractionElement = document.getElementById('score-fraction');
            if (fractionElement) {
                fractionElement.textContent = `${countTestsTaken} test${countTestsTaken !== 1 ? 's' : ''}`;
            }

            // Determine number of unlocked cards based on overall progress thresholds
            let unlockedCards = 1;
            if (overall >= 100) unlockedCards = 2;
            if (overall >= 150) unlockedCards = 3;
            if (overall >= 200) unlockedCards = 4;
            if (overall >= 250) unlockedCards = 5;
            if (overall >= 300) unlockedCards = 6;

            // Define unlock levels for each card
            const unlockLevels = {
                1: 'Novice',
                2: 'Intermediate',
                3: 'Advanced',
                4: 'Expert'
            };

            // Smaller cards: select all text-2xl font-bold white spans in grid
            const cards = document.querySelectorAll('.grid.grid-cols-3 .text-2xl.font-bold.text-white');
            const cardIcons = document.querySelectorAll('.grid.grid-cols-3 .w-6.h-6');
            if (cards.length >= 6) {
                const [accuracy, efficiency, time, style, errors] = averages;

                for (let i = 0; i < 6; i++) {
                    const isUnlocked = i === 5 || i < unlockedCards;
                    if (isUnlocked) {
                        // Set values for unlocked cards
                        if (i < 5) {
                            cards[i].textContent = `${averages[i]}%`;
                        } else {
                            cards[i].textContent = `${totalPoints} pts`;
                        }
                        // Set original icon and color
                        if (cardIcons[i]) {
                            const originalIcons = ['target', 'code', 'clock', 'zap', 'alert-triangle', 'star'];
                            cardIcons[i].setAttribute('data-lucide', originalIcons[i]);
                            cardIcons[i].style.color = ''; // reset to original color
                        }
                    } else {
                        // Set locked state
                        cards[i].textContent = `${unlockLevels[i]}`;
                        if (cardIcons[i]) {
                            cardIcons[i].setAttribute('data-lucide', 'lock');
                            cardIcons[i].style.color = '#9ca3af'; // gray-400
                        }
                    }
                }
            }

            // Rerender icons after attribute changes
            lucide.createIcons();

            // Update total points description if present
            const totalPtsElement = document.querySelector('.grid.grid-cols-3 .text-xs.text-gray-500');
            if (totalPtsElement && totalPtsElement.textContent.includes('Total:')) {
                totalPtsElement.textContent = `Recent: ${averages[5]} pts`;
            }

            console.log('UI populated with results:', { overall, averages, totalCorrect, countCorrectness });
        }
        // Wait for supabase to be available, then protect the page
        function checkAndProtect() {
            if (!supabase || !supabase.auth) {
                setTimeout(checkAndProtect, 10); // Check again in 10ms
                return;
            }
            
            // Protect this page, only 'candidate' role is authorized
            protectPage(['candidate']).then(async ({ user, profile }) => {
            if (user && profile) {
                // User is authorized, proceed with rendering the results page
                lucide.createIcons();

                // Load results data and average performance data
                const [resultData, avgPerformance] = await Promise.all([
                    loadResults(user.id),
                    getAveragePerformance()
                ]);
                const averages = resultData.averages || [0, 0, 0, 0, 0];

                // Populate classification card with total score, test count, and individual factors
                const totalScore = resultData.totalScore || 0;
                const testCount = resultData.testCount || 0;
                populateClassificationCard(totalScore, testCount, averages);

                // Populate question-by-question breakdown with real test data
                const testResults = resultData.testResults || [];
                populateTestBreakdown(testResults);

                // Map averages to chart labels: ['Accuracy', 'Efficiency', 'Code Style', 'Error Handling', 'Runtime']
                // averages: [accuracy, efficiency, avgTime, style, errors]
                const chartData = [
                    averages[0], // Accuracy (direct: higher is better)
                    averages[1], // Efficiency (direct: higher is better)
                    averages[3], // Code Style (direct: higher is better)
                    averages[4] === 0 ? 0 : Math.max(0, 100 - averages[4]), // Error Handling (if no data/errors=0, show 0; else invert since fewer errors = better)
                    averages[2] === 0 ? 0 : Math.max(0, 100 - averages[2])  // Runtime (if no data/time=0, show 0; else invert since less time = better)
                ];

                // Radar Chart
                const ctx = document.getElementById('radarChart').getContext('2d');
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Accuracy', 'Efficiency', 'Code Style', 'Error Handling', 'Runtime'],
                        datasets: [{
                            label: 'Your Performance',
                            data: chartData,
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(16, 185, 129, 1)'
                        }, {
                            label: 'Average Performance',
                            data: avgPerformance,
                            backgroundColor: 'rgba(100, 116, 139, 0.2)',
                            borderColor: 'rgba(100, 116, 139, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(100, 116, 139, 1)'
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: '#9ca3af',
                                    backdropColor: 'transparent'
                                },
                                grid: {
                                    color: '#374151'
                                },
                                pointLabels: {
                                    color: '#d1d5db',
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#d1d5db'
                                }
                            }
                        }
                    }
                });
            }
        });

        }

        // Start checking for supabase availability and protect the page
        checkAndProtect();

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await logout();
            window.location.href = '/jsat/app/auth/login.html';
        });
        }
    </script>
    <script>lucide.createIcons();</script>
</body>
</html>
